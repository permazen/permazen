<!DOCTYPE HTML>
<html lang="en">
<head>
<!-- Generated by javadoc (17) -->
<title>OnChange (Permazen 5.0.0 API)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="description" content="declaration: package: io.permazen.annotation, annotation type: OnChange">
<meta name="generator" content="javadoc/ClassWriterImpl">
<link rel="stylesheet" type="text/css" href="../../../stylesheet.css" title="Style">
<link rel="stylesheet" type="text/css" href="../../../script-dir/jquery-ui.min.css" title="Style">
<link rel="stylesheet" type="text/css" href="../../../jquery-ui.overrides.css" title="Style">
<script type="text/javascript" src="../../../script.js"></script>
<script type="text/javascript" src="../../../script-dir/jquery-3.6.1.min.js"></script>
<script type="text/javascript" src="../../../script-dir/jquery-ui.min.js"></script>
</head>
<body class="class-declaration-page">
<script type="text/javascript">var pathtoroot = "../../../";
loadScripts(document, 'script');</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<div class="flex-box">
<header role="banner" class="flex-header">
<nav role="navigation">
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="top-nav" id="navbar-top">
<div class="skip-nav"><a href="#skip-navbar-top" title="Skip navigation links">Skip navigation links</a></div>
<ul id="navbar-top-firstrow" class="nav-list" title="Navigation">
<li><a href="../../../index.html">Overview</a></li>
<li><a href="package-summary.html">Package</a></li>
<li class="nav-bar-cell1-rev">Class</li>
<li><a href="class-use/OnChange.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../index-all.html">Index</a></li>
<li><a href="../../../help-doc.html#class">Help</a></li>
</ul>
</div>
<div class="sub-nav">
<div>
<ul class="sub-nav-list">
<li>Summary:&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li><a href="#annotation-interface-optional-element-summary">Optional</a>&nbsp;|&nbsp;</li>
<li>Required</li>
</ul>
<ul class="sub-nav-list">
<li>Detail:&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li><a href="#annotation-interface-element-detail">Element</a></li>
</ul>
</div>
<div class="nav-list-search"><label for="search-input">SEARCH:</label>
<input type="text" id="search-input" value="search" disabled="disabled">
<input type="reset" id="reset-button" value="reset" disabled="disabled">
</div>
</div>
<!-- ========= END OF TOP NAVBAR ========= -->
<span class="skip-nav" id="skip-navbar-top"></span></nav>
</header>
<div class="flex-content">
<main role="main">
<!-- ======== START OF CLASS DATA ======== -->
<div class="header">
<div class="sub-title"><span class="package-label-in-type">Package</span>&nbsp;<a href="package-summary.html">io.permazen.annotation</a></div>
<h1 title="Annotation Interface OnChange" class="title">Annotation Interface OnChange</h1>
</div>
<section class="class-description" id="class-description">
<hr>
<div class="type-signature"><span class="annotations"><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/annotation/Retention.html" title="class or interface in java.lang.annotation" class="external-link">@Retention</a>(<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/annotation/RetentionPolicy.html#RUNTIME" title="class or interface in java.lang.annotation" class="external-link">RUNTIME</a>)
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/annotation/Target.html" title="class or interface in java.lang.annotation" class="external-link">@Target</a>({<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/annotation/ElementType.html#ANNOTATION_TYPE" title="class or interface in java.lang.annotation" class="external-link">ANNOTATION_TYPE</a>,<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/annotation/ElementType.html#METHOD" title="class or interface in java.lang.annotation" class="external-link">METHOD</a>})
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/annotation/Documented.html" title="class or interface in java.lang.annotation" class="external-link">@Documented</a>
</span><span class="modifiers">public @interface </span><span class="element-name type-name-label">OnChange</span></div>
<div class="block">Annotates methods to be invoked whenever some target field in some target object changes during a transaction.

 <p><b>Overview</b></p>

 <p>
 When the value of a matching field in a matching object changes, a change event is created and the annotated
 method is invoked. The change event's type will be some sub-type of <a href="../change/FieldChange.html" title="class in io.permazen.change"><code>FieldChange</code></a> appropriate for the
 type of field and the change that occurred. Only change events whose types are compatible with the method's
 parameter are delivered.

 <p>
 A "matching object" is one that is found at the end of the <a href="../ReferencePath.html" title="class in io.permazen">reference path</a> specified
 by <a href="#path()"><code>path()</code></a>, starting from the object to be notified; see <a href="../ReferencePath.html" title="class in io.permazen"><code>ReferencePath</code></a> for more information about
 reference paths.

 <p>
 By default, the reference path is empty, which means changes in the target object itself are monitored.

 <p>
 A "matching field" is one named in <a href="#value()"><code>value()</code></a>, or every event-generating field if <a href="#value()"><code>value()</code></a> is empty.

 <p>
 A class may have multiple <a href="OnChange.html" title="annotation interface in io.permazen.annotation"><code>&#64;OnChange</code></a> methods, each with a specific purpose.

 <p><b>Examples</b></p>

 <pre>
   &#64;PermazenType
   public abstract class Account implements PermazenObject {

   // Database fields

       public abstract boolean isEnabled();
       public abstract void setEnabled(boolean enabled);

       &#64;NotNull
       public abstract String getName();
       public abstract void setName(String name);

       public abstract NavigableSet&lt;AccessLevel&gt; getAccessLevels();

   // &#64;OnChange methods

       &#64;OnChange
       private void handleAnyChange1(FieldChange&lt;Account&gt; change) {
           // Sees any change to ANY field of THIS account
       }

       &#64;OnChange
       private static void handleAnyChange2(FieldChange&lt;Account&gt; change) {
           // Sees any change to ANY field of ANY account (note static method)
       }

       &#64;OnChange("accessLevels")
       private void handleAccessLevelsChange(SetFieldAdd&lt;Account, AccessLevel&gt; change) {
           // Sees any addition to THIS accounts access levels
       }

       &#64;OnChange
       private void handleSimpleChange(SimpleFieldChange&lt;Account, ?&gt; change) {
           // Sees any change to any SIMPLE field of THIS account (i.e., "enabled", "name")
       }
   }

   &#64;PermazenType
   public abstract class User implements PermazenObject {

   // Database fields

       &#64;NotNull
       &#64;PermazenField(indexed = true, unique = true)
       public abstract String getUsername();
       public abstract void setUsername(String username);

       &#64;NotNull
       public abstract Account getAccount();
       public abstract void setAccount(Account account);

       public abstract NavigableSet&lt;User&gt; getFriends();

   // &#64;OnChange methods

       &#64;OnChange("username")
       private void handleUsernameChange(SimpleFieldChange&lt;User, String&gt; change) {
           // Sees any change to THIS user's username
       }

       &#64;OnChange(path = "account", value = "enabled")
       private void handleUsernameChange(SimpleFieldChange&lt;Account, Boolean&gt; change) {
           // Sees any change to THIS user's account's enabled status
       }

       &#64;OnChange(path = "-&gt;friends-&gt;friends-&gt;account")
       private void handleFOFAccountNameChange(SimpleFieldChange&lt;Account, ?&gt; change) {
           // Sees any change to ANY simple field in ANY friend-of-a-friend's Account
       }

       &#64;OnChange(path = "-&gt;account&lt;-User.account", value = "username")
       private void handleSameAccountUserUsernameChange(SimpleFieldChange&lt;User, String&gt; change) {
           // Sees changes to the username of any User having the same Account as this User.
           // Note the use of the inverse step "&lt;-User.account" from Account back to User
       }

       &#64;OnChange("account")
       private static void handleMembershipChange(SimpleFieldChange&lt;User, Account&gt; change) {
           // Sees any change to ANY user's account
       }
   }
 </pre>

 <p><b>Method Parameter Types</b></p>

 <p>
 In all cases the annotated method must return void and take one parameter whose type must be compatible
 with at least one of the <a href="../change/FieldChange.html" title="class in io.permazen.change"><code>FieldChange</code></a> sub-types appropriate for the/a field being monitored. The
 parameter type can be narrowed to restrict which notifications are delivered. For example, a method with a
 <a href="../change/SetFieldChange.html" title="class in io.permazen.change"><code>SetFieldChange</code></a> parameter will receive notifications about all changes to a set field, but a method
 with a <a href="../change/SetFieldAdd.html" title="class in io.permazen.change"><code>SetFieldAdd</code></a> parameter will receive notification only when an element is added to the set.

 <p>
 The method may have any level of access, including <code>private</code>, and multiple independent <a href="OnChange.html" title="annotation interface in io.permazen.annotation"><code>&#64;OnChange</code></a>
 methods are allowed.

 <p>
 Multiple fields in the target object may be specified; if so, all of the fields are monitored together, and they all
 must emit <a href="../change/FieldChange.html" title="class in io.permazen.change"><code>FieldChange</code></a>s compatible with the method's parameter type. Therefore, when multiple fields are monitored
 by the same method, the method's parameter type may need to be widened to accomodate them all.

 <p>
 If <a href="#value()"><code>value()</code></a> is empty (the default), then every field in the target object is monitored,
 though again only changes compatible with the method's parameter type will be delivered. So for example, a method
 taking a <a href="../change/SetFieldChange.html" title="class in io.permazen.change"><code>SetFieldChange</code></a> would receive notifications about changes to all <code>Set</code> fields in the class,
 but not any other fields.

 <p>
 Currently, due to type erasure, only the parameter's raw type is taken into consideration and an error is generated
 if the parameter's generic type and its raw type don't match the same events.

 <p><b>Instance vs. Static Methods</b></p>

 <p>
 For an instance method, the method will be invoked on each object for which the changed field is
 found at the end of the specified reference path starting from that object. So if there are three
 <code>Child</code> objects, and the <code>Child</code> class has an instance method annotated with
 <a href="OnChange.html" title="annotation interface in io.permazen.annotation"><code>&#64;OnChange</code></a><code>(path = "parent", value = "name")</code>, then all three <code>Child</code> objects
 will be notified when the parent's name changes.

 <p>
 If the instance is a static method, then the method is invoked once when any instance of the class containing
 the method exists for which the changed field is found at the end of the specified reference path, no matter how many
 such instances there are. So in the previous example, making the method static would cause it to be invoked once
 when the parent's name changes.

 <p><b>Notification Delivery</b></p>

 <p>
 Notifications are delivered synchronously within the thread the made the change, after the change is made and just
 prior to returning to the original caller.
 Additional changes made within an <a href="OnChange.html" title="annotation interface in io.permazen.annotation"><code>&#64;OnChange</code></a> handler that themselves result in notifications
 are also handled prior to returning to the original caller. Put another way, the queue of outstanding notifications
 triggered by invoking a method that changes any field is emptied before that method returns. Therefore, infinite loops
 are possible if an <a href="OnChange.html" title="annotation interface in io.permazen.annotation"><code>&#64;OnChange</code></a> handler method modifies the field it's monitoring (directly, or indirectly via
 other <a href="OnChange.html" title="annotation interface in io.permazen.annotation"><code>&#64;OnChange</code></a> handler methods).

 <p>
 <a href="OnChange.html" title="annotation interface in io.permazen.annotation"><code>&#64;OnChange</code></a> functions within a single transaction; it does not notify about changes that
 occur in other transactions.

 <p><b>Fields of Sub-Types</b>

 <p>
 The same field can appear in multiple sub-types, e.g., when implementing a Java interface containing a Permazen field.
 This can lead to some subtleties: for example, in some cases, a field may not exist in a Java object type, but it does
 exist in a some sub-type of that type:

 <pre>
 &#64;PermazenType
 public abstract class <b>Person</b> {

     public abstract Set&lt;Person&gt; <b>getFriends</b>();

     &#64;OnChange(path = "friends", field="<b>name</b>")
     private void friendNameChanged(SimpleFieldChange&lt;NamedPerson, String&gt; change) {
         // ... do whatever
     }
 }

 &#64;PermazenType
 public abstract class <b>NamedPerson</b> extends Person {

     public abstract String <b>getName</b>();
     public abstract void setName(String name);
 }
 </pre>

 Here the path <code>"friends.name"</code> seems incorrect because <code>"friends"</code> has type <code>Person</code>,
 while <code>"name"</code> is a field of <code>NamedPerson</code>, a narrower type than <code>Person</code>. However, this will still
 work as long as there is no ambiguity, i.e., in this example, there are no other sub-types of <code>Person</code> with a
 different field named <code>"name"</code>.

 <p>
 Note also in the example above the <a href="../change/SimpleFieldChange.html" title="class in io.permazen.change"><code>SimpleFieldChange</code></a> parameter to the method <code>friendNameChanged()</code>
 necessarily has generic type <code>NamedPerson</code>, not <code>Person</code>.

 <p><b>Other Notes</b></p>

 <p>
 <a href="../Counter.html" title="class in io.permazen"><code>Counter</code></a> fields do not generate change notifications.

 <p>
 No notifications are delivered for "changes" that do not actually change anything (e.g., setting a simple field to
 the value already contained in that field, or adding an element to a set which is already contained in the set).

 <p>
 For any given field change and path, only one notification will be delivered per recipient object, even if the changed field
 is seen through the path in multiple ways (e.g., via reference path <code>"mylist.myfield"</code> where the changed object
 containing <code>myfield</code> appears multiple times in <code>mylist</code>).

 <p>
 Some notifications may need to be ignored by objects in <a href="../DetachedPermazenTransaction.html" title="class in io.permazen">detached</a> transactions;
 you can use <code>this.isDetached()</code> to detect that situation.

 <p>
 When handing change events, any action that has effects visible to the outside world should be made contingent on
 successful transaction commit, for example, by wrapping it in <a href="../core/Transaction.html#addCallback(io.permazen.core.Transaction.Callback)"><code>Transaction.addCallback()</code></a>.

 <p>
 See <a href="../core/Transaction.html#addSimpleFieldChangeListener(int,int%5B%5D,io.permazen.kv.KeyRanges%5B%5D,io.permazen.core.SimpleFieldChangeListener)"><code>Transaction.addSimpleFieldChangeListener()</code></a>
 for further information on other special corner cases.

 <p><b>Meta-Annotations</b></p>

 <p>
 This annotation may be configured indirectly as a Spring
 <a href="https://docs.spring.io/spring-framework/reference/core/beans/classpath-scanning.html#beans-meta-annotations">meta-annotation</a>
 when <code>spring-core</code> is on the classpath.</div>
<dl class="notes">
<dt>See Also:</dt>
<dd>
<ul class="see-list">
<li><a href="../ReferencePath.html" title="class in io.permazen"><code>ReferencePath</code></a></li>
<li><a href="../change/package-summary.html"><code>io.permazen.change</code></a></li>
</ul>
</dd>
</dl>
</section>
<section class="summary">
<ul class="summary-list">
<!-- =========== ANNOTATION INTERFACE OPTIONAL MEMBER SUMMARY =========== -->
<li>
<section class="member-summary" id="annotation-interface-optional-element-summary">
<h2>Optional Element Summary</h2>
<div class="caption"><span>Optional Elements</span></div>
<div class="summary-table three-column-summary">
<div class="table-header col-first">Modifier and Type</div>
<div class="table-header col-second">Optional Element</div>
<div class="table-header col-last">Description</div>
<div class="col-first even-row-color"><code><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a></code></div>
<div class="col-second even-row-color"><code><a href="#path()" class="member-name-link">path</a></code></div>
<div class="col-last even-row-color">
<div class="block">Specify the reference path to the target object(s) that should be monitored for changes.</div>
</div>
<div class="col-first odd-row-color"><code><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a>[]</code></div>
<div class="col-second odd-row-color"><code><a href="#value()" class="member-name-link">value</a></code></div>
<div class="col-last odd-row-color">
<div class="block">Specify the fields in the target object(s) that should be monitored for changes.</div>
</div>
</div>
</section>
</li>
</ul>
</section>
<section class="details" id="annotation-interface-element-detail">
<ul class="details-list">
<!-- ============ ANNOTATION INTERFACE MEMBER DETAIL =========== -->
<li>
<section class="member-details">
<h2>Element Details</h2>
<ul class="member-list">
<li>
<section class="detail" id="path()">
<h3>path</h3>
<div class="member-signature"><span class="return-type"><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a></span>&nbsp;<span class="element-name">path</span></div>
<div class="block">Specify the reference path to the target object(s) that should be monitored for changes.
 See <a href="../ReferencePath.html" title="class in io.permazen"><code>ReferencePath</code></a> for information on reference paths and their proper syntax.

 <p>
 The default empty path means the monitored object and the notified object are the same.

 <p>
 In the case of static methods, a non-empty path restricts notification from being delivered
 unless there exists at least one object for whom the monitored object is found at the other
 end of the path.</div>
<dl class="notes">
<dt>Returns:</dt>
<dd>reference path leading to monitored objects</dd>
<dt>See Also:</dt>
<dd>
<ul class="see-list">
<li><a href="../ReferencePath.html" title="class in io.permazen"><code>ReferencePath</code></a></li>
</ul>
</dd>
</dl>
<dl class="notes">
<dt>Default:</dt>
<dd>""</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="value()">
<h3>value</h3>
<div class="member-signature"><span class="return-type"><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a>[]</span>&nbsp;<span class="element-name">value</span></div>
<div class="block">Specify the fields in the target object(s) that should be monitored for changes.

 <p>
 Multiple fields may be specified; if so, each field is handled as a separate independent listener registration,
 and for each field, the method's parameter type must be compatible with at least one of the <a href="../change/FieldChange.html" title="class in io.permazen.change"><code>FieldChange</code></a>
 event sub-types emitted by that field.

 <p>
 If zero paths are specified (the default), every field in the target object(s) that emits
 <a href="../change/FieldChange.html" title="class in io.permazen.change"><code>FieldChange</code></a>s compatible with the method's parameter type will be monitored for changes.</div>
<dl class="notes">
<dt>Returns:</dt>
<dd>the names of the fields to monitored in the target objects</dd>
</dl>
<dl class="notes">
<dt>Default:</dt>
<dd>{}</dd>
</dl>
</section>
</li>
</ul>
</section>
</li>
</ul>
</section>
<!-- ========= END OF CLASS DATA ========= -->
</main>
<footer role="contentinfo">
<hr>
<p class="legal-copy"><small>Copyright &#169; 2024. All rights reserved.</small></p>
</footer>
</div>
</div>
</body>
</html>
