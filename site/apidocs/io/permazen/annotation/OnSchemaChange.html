<!DOCTYPE HTML>
<html lang="en">
<head>
<!-- Generated by javadoc (17) -->
<title>OnSchemaChange (Permazen 5.2.0 API)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="description" content="declaration: package: io.permazen.annotation, annotation type: OnSchemaChange">
<meta name="generator" content="javadoc/ClassWriterImpl">
<link rel="stylesheet" type="text/css" href="../../../stylesheet.css" title="Style">
<link rel="stylesheet" type="text/css" href="../../../script-dir/jquery-ui.min.css" title="Style">
<link rel="stylesheet" type="text/css" href="../../../jquery-ui.overrides.css" title="Style">
<script type="text/javascript" src="../../../script.js"></script>
<script type="text/javascript" src="../../../script-dir/jquery-3.7.1.min.js"></script>
<script type="text/javascript" src="../../../script-dir/jquery-ui.min.js"></script>
</head>
<body class="class-declaration-page">
<script type="text/javascript">var pathtoroot = "../../../";
loadScripts(document, 'script');</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<div class="flex-box">
<header role="banner" class="flex-header">
<nav role="navigation">
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="top-nav" id="navbar-top">
<div class="skip-nav"><a href="#skip-navbar-top" title="Skip navigation links">Skip navigation links</a></div>
<ul id="navbar-top-firstrow" class="nav-list" title="Navigation">
<li><a href="../../../index.html">Overview</a></li>
<li><a href="package-summary.html">Package</a></li>
<li class="nav-bar-cell1-rev">Class</li>
<li><a href="class-use/OnSchemaChange.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../index-all.html">Index</a></li>
<li><a href="../../../help-doc.html#class">Help</a></li>
</ul>
</div>
<div class="sub-nav">
<div>
<ul class="sub-nav-list">
<li>Summary:&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li>Optional&nbsp;|&nbsp;</li>
<li>Required</li>
</ul>
<ul class="sub-nav-list">
<li>Detail:&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li>Element</li>
</ul>
</div>
<div class="nav-list-search"><label for="search-input">SEARCH:</label>
<input type="text" id="search-input" value="search" disabled="disabled">
<input type="reset" id="reset-button" value="reset" disabled="disabled">
</div>
</div>
<!-- ========= END OF TOP NAVBAR ========= -->
<span class="skip-nav" id="skip-navbar-top"></span></nav>
</header>
<div class="flex-content">
<main role="main">
<!-- ======== START OF CLASS DATA ======== -->
<div class="header">
<div class="sub-title"><span class="package-label-in-type">Package</span>&nbsp;<a href="package-summary.html">io.permazen.annotation</a></div>
<h1 title="Annotation Interface OnSchemaChange" class="title">Annotation Interface OnSchemaChange</h1>
</div>
<section class="class-description" id="class-description">
<hr>
<div class="type-signature"><span class="annotations"><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/annotation/Retention.html" title="class or interface in java.lang.annotation" class="external-link">@Retention</a>(<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/annotation/RetentionPolicy.html#RUNTIME" title="class or interface in java.lang.annotation" class="external-link">RUNTIME</a>)
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/annotation/Target.html" title="class or interface in java.lang.annotation" class="external-link">@Target</a>({<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/annotation/ElementType.html#ANNOTATION_TYPE" title="class or interface in java.lang.annotation" class="external-link">ANNOTATION_TYPE</a>,<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/annotation/ElementType.html#METHOD" title="class or interface in java.lang.annotation" class="external-link">METHOD</a>})
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/annotation/Documented.html" title="class or interface in java.lang.annotation" class="external-link">@Documented</a>
</span><span class="modifiers">public @interface </span><span class="element-name type-name-label">OnSchemaChange</span></div>
<div class="block">Annotation for methods that are to be invoked whenever an object's schema has just changed,
 in order to apply "semantic" schema migration logic.

 <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.27.0/prism.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.27.0/components/prism-java.min.js"></script>
 <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.27.0/themes/prism.min.css" rel="stylesheet"/>

 <p>
 The annotated method is given access to all of the values in the previous object version's fields, including for
 fields that have been removed or changed types. This allows the object to perform any schema migration
 "fixups" that may be required before the old information is lost for good.

 <p>
 Simple changes that only modify a simple field's type can often be handled automatically; see
 <a href="../UpgradeConversionPolicy.html" title="enum class in io.permazen"><code>UpgradeConversionPolicy</code></a>, <a href="PermazenField.html#upgradeConversion()"><code>&#64;PermazenField.upgradeConversion()</code></a>,
 and <a href="../encoding/Encoding.html#convert(io.permazen.encoding.Encoding,S)"><code>Encoding.convert()</code></a> for details.

 <p>
 The annotated method must be an instance method (i.e., not static), return void, and take from one to three parameters.
 The first parameter must have type <code>Map&lt;String, Object&gt; oldValues</code> and will be an immutable map containing the values
 of all the fields in the previous schema version of the object indexed by field name. The optional second and third
 parameters have type <a href="../schema/SchemaId.html" title="class in io.permazen.schema"><code>SchemaId</code></a> and identify the old and new schemas (respectively).

 <p>
 In many cases, the simplest way to handle schema changes is to use the presence or absence of fields in <code>oldValues</code>
 to determine what migration work needs to be done. For example:
 <pre><code class="language-java">
      &#64;OnSchemaChange
      private void applySchemaChanges(Map&lt;String, Object&gt; oldValues) {

          // At some point we added a new field "balance"
          if (!oldValues.containsKey("balance"))
              this.setBalance(this.calculateBalanceForSchemaMigration());

          // At some point we replaced "fullName" with "lastName" &amp; "firstName"
          if (oldValues.containsKey("fullName")) {
              final String fullName = (String)oldValues.get("fullName");
              if (fullName != null) {
                  final int comma = fullName.indexOf(',');
                  this.setLastName(comma == -1 ? null : fullName.substring(0, comma));
                  this.setFirstName(fullName.substring(comma + 1).trim());
              }
          }
          // ...etc
      }
 </code></pre>

 <p>
 A class may have multiple <a href="OnSchemaChange.html" title="annotation interface in io.permazen.annotation"><code>&#64;OnSchemaChange</code></a>-annotated methods.

 <p><b>Incompatible Object Type Changes</b></p>

 <p>
 Permazen supports arbitrary Java model schema changes across schemas, including adding and removing Java types.
 This creates a few caveats relating to schema migration.

 <p>
 First, if an object's type no longer exists in the new schema, migration is not possible, and any attempt to do so will
 throw a <a href="../core/TypeNotInSchemaException.html" title="class in io.permazen.core"><code>TypeNotInSchemaException</code></a>. Such objects are still accessible however (see <a href="../UntypedPermazenObject.html" title="class in io.permazen"><code>UntypedPermazenObject</code></a>).

 <p>
 Secondly, it's possible for an old field to have a value that can no longer be represented within the new schema.
 When this happens, it's not possible to provide the old value to an <a href="OnSchemaChange.html" title="annotation interface in io.permazen.annotation"><code>&#64;OnSchemaChange</code></a> method
 in its original form.

 <p>
 This can happen in two ways:
 <ul>
 <li>A reference field refers to an object whose type no longer exists in the new schema; or</li>
 <li>An <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/Enum.html" title="class or interface in java.lang" class="external-link"><code>Enum</code></a> field refers to an <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/Enum.html" title="class or interface in java.lang" class="external-link"><code>Enum</code></a> type that no longer exists, or whose identifiers have changed
      (this is really just a special case of the previous scenario: when an <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/Enum.html" title="class or interface in java.lang" class="external-link"><code>Enum</code></a> type's constants change
      in any way, the new <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/Enum.html" title="class or interface in java.lang" class="external-link"><code>Enum</code></a> is treated as a completely new type).</li>
 </ul>

 <p>
 Therefore, the following special rules apply to the <code>oldValues</code> map:
 <ul>
 <li>For a reference field whose type no longer exists, the referenced object will appear as an <a href="../UntypedPermazenObject.html" title="class in io.permazen"><code>UntypedPermazenObject</code></a>.
 <li>For <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/Enum.html" title="class or interface in java.lang" class="external-link"><code>Enum</code></a> fields, old values are always represented as <a href="../core/EnumValue.html" title="class in io.permazen.core"><code>EnumValue</code></a> objects.
      For consistency's sake, this is true <i>even if the associated field's type has not changed</i>.</li>
 </ul>

 <p>
 In addition, <a href="../PermazenCounterField.html" title="class in io.permazen">PermazenCounterField</a> values are represented in <code>oldValues</code> as values of type <code>Long</code>.

 <p><b>Meta-Annotations</b></p>

 <p>
 This annotation may be configured indirectly as a Spring
 <a href="https://docs.spring.io/spring-framework/reference/core/beans/classpath-scanning.html#beans-meta-annotations">meta-annotation</a>
 when <code>spring-core</code> is on the classpath.</div>
<dl class="notes">
<dt>See Also:</dt>
<dd>
<ul class="see-list-long">
<li><a href="../encoding/Encoding.html#convert(io.permazen.encoding.Encoding,S)"><code>Encoding.convert()</code></a></li>
<li><a href="PermazenField.html#upgradeConversion()"><code>&#64;PermazenField.upgradeConversion()</code></a></li>
</ul>
</dd>
</dl>
</section>
<!-- ========= END OF CLASS DATA ========= -->
</main>
<footer role="contentinfo">
<hr>
<p class="legal-copy"><small>Copyright &#169; 2024. All rights reserved.</small></p>
</footer>
</div>
</div>
</body>
</html>
