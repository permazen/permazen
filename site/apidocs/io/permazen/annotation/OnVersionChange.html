<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<!-- Generated by javadoc -->
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>OnVersionChange (Permazen 4.1.9 API)</title>
<link rel="stylesheet" type="text/css" href="../../../stylesheet.css" title="Style">
<script type="text/javascript" src="../../../script.js"></script>
</head>
<body>
<script type="text/javascript"><!--
    try {
        if (location.href.indexOf('is-external=true') == -1) {
            parent.document.title="OnVersionChange (Permazen 4.1.9 API)";
        }
    }
    catch(err) {
    }
//-->
</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="topNav"><a name="navbar.top">
<!--   -->
</a>
<div class="skipNav"><a href="#skip.navbar.top" title="Skip navigation links">Skip navigation links</a></div>
<a name="navbar.top.firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../overview-summary.html">Overview</a></li>
<li><a href="package-summary.html">Package</a></li>
<li class="navBarCell1Rev">Class</li>
<li><a href="class-use/OnVersionChange.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../index-all.html">Index</a></li>
<li><a href="../../../help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../io/permazen/annotation/OnValidate.html" title="annotation in io.permazen.annotation"><span class="typeNameLink">Prev&nbsp;Class</span></a></li>
<li><a href="../../../io/permazen/annotation/PermazenType.html" title="annotation in io.permazen.annotation"><span class="typeNameLink">Next&nbsp;Class</span></a></li>
</ul>
<ul class="navList">
<li><a href="../../../index.html?io/permazen/annotation/OnVersionChange.html" target="_top">Frames</a></li>
<li><a href="OnVersionChange.html" target="_top">No&nbsp;Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_top">
<li><a href="../../../allclasses-noframe.html">All&nbsp;Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_top");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<div>
<ul class="subNavList">
<li>Summary:&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li>Required&nbsp;|&nbsp;</li>
<li><a href="#annotation.type.optional.element.summary">Optional</a></li>
</ul>
<ul class="subNavList">
<li>Detail:&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li><a href="#annotation.type.element.detail">Element</a></li>
</ul>
</div>
<a name="skip.navbar.top">
<!--   -->
</a></div>
<!-- ========= END OF TOP NAVBAR ========= -->
<!-- ======== START OF CLASS DATA ======== -->
<div class="header">
<div class="subTitle">io.permazen.annotation</div>
<h2 title="Annotation Type OnVersionChange" class="title">Annotation Type OnVersionChange</h2>
</div>
<div class="contentContainer">
<div class="description">
<ul class="blockList">
<li class="blockList">
<hr>
<br>
<pre><a href="https://docs.oracle.com/javase/8/docs/api/java/lang/annotation/Retention.html?is-external=true" title="class or interface in java.lang.annotation">@Retention</a>(<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/annotation/Retention.html?is-external=true#value--" title="class or interface in java.lang.annotation">value</a>=<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/annotation/RetentionPolicy.html?is-external=true#RUNTIME" title="class or interface in java.lang.annotation">RUNTIME</a>)
 <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/annotation/Target.html?is-external=true" title="class or interface in java.lang.annotation">@Target</a>(<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/annotation/Target.html?is-external=true#value--" title="class or interface in java.lang.annotation">value</a>={<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/annotation/ElementType.html?is-external=true#ANNOTATION_TYPE" title="class or interface in java.lang.annotation">ANNOTATION_TYPE</a>,<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/annotation/ElementType.html?is-external=true#METHOD" title="class or interface in java.lang.annotation">METHOD</a>})
 <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/annotation/Documented.html?is-external=true" title="class or interface in java.lang.annotation">@Documented</a>
public @interface <span class="memberNameLabel">OnVersionChange</span></pre>
<div class="block">Annotation for methods that are to be invoked whenever an object's schema version has just changed,
 in order to apply arbitrary "semantic" schema migration logic.

 <p>
 The annotated method is given access to all of the previous object version's fields, including fields that have
 been deleted or whose types have changed in the new schema version. This allows the object to perform any
 schema migration "fixups" required before the old information is lost.

 <p>
 Simple changes that only modify a simple field's type can often be handled automatically; see
 <a href="../../../io/permazen/UpgradeConversionPolicy.html" title="enum in io.permazen"><code>UpgradeConversionPolicy</code></a>, <a href="../../../io/permazen/annotation/JField.html#upgradeConversion--"><code>&#64;JField.upgradeConversion()</code></a>,
 and <a href="../../../io/permazen/core/FieldType.html#convert-io.permazen.core.FieldType-S-"><code>FieldType.convert()</code></a> for details.

 <p><b>Method Parameters</b></p>

 <p>
 The annotated method must be an instance method (i.e., not static), return void, and
 take zero, one, two, or all three of the following parameters (in this order):
 <ol>
 <li><code>int oldVersion</code> - previous schema version; required if <a href="../../../io/permazen/annotation/OnVersionChange.html#oldVersion--"><code>oldVersion()</code></a> is unspecified (i.e., zero)</li>
 <li><code>int newVersion</code> - new schema version; required if <a href="../../../io/permazen/annotation/OnVersionChange.html#newVersion--"><code>newVersion()</code></a> is unspecified (i.e., zero)</li>
 <li><code>Map&lt;Integer, Object&gt; oldValues</code> <i>or</i> <code>Map&lt;String, Object&gt; oldValues</code> - immutable map containing
      all field values from the previous version of the object, indexed by either storage ID or field name.</li>
 </ol>

 <p>
 In addition to the above options, you may also completely ignore the schema version numbers by leaving <a href="../../../io/permazen/annotation/OnVersionChange.html#oldVersion--"><code>oldVersion()</code></a>
 and <a href="../../../io/permazen/annotation/OnVersionChange.html#newVersion--"><code>newVersion()</code></a> unspecified and declaring the method with only the <code>oldValues</code> parameter.
 In many cases, this is the simplest way to handle schema changes: ignore version numbers and instead just using the
 presence or absence of fields in <code>oldValues</code> to determine what migration work needs to be done. For example:
 <pre>
      &#64;OnVersionChange
      private void applySchemaChanges(Map&lt;String, Object&gt; oldValues) {
          if (!oldValues.containsKey("balance"))      // at some point we added a new field "balance"
              this.setBalance(DEFAULT_BALANCE);
          if (oldValues.containsKey("fullName")) {    // we replaced "fullName" with "lastName" &amp; "firstName"
              final String fullName = (String)oldValues.get("fullName");
              if (fullName != null) {
                  final int comma = fullName.indexOf(',');
                  this.setLastName(comma == -1 ? null : fullName.substring(0, comma));
                  this.setFirstName(fullName.substring(comma + 1).trim());
              }
          }
          // ...etc
      }
 </pre>

 <p>
 If a class has multiple <a href="../../../io/permazen/annotation/OnVersionChange.html" title="annotation in io.permazen.annotation"><code>&#64;OnVersionChange</code></a>-annotated methods, methods with more specific
 constraint(s) (i.e., non-zero <a href="../../../io/permazen/annotation/OnVersionChange.html#oldVersion--"><code>oldVersion()</code></a> and/or <a href="../../../io/permazen/annotation/OnVersionChange.html#newVersion--"><code>newVersion()</code></a>) will be invoked first.

 <p><b>Incompatible Object Type Changes</b></p>

 <p>
 Permazen supports arbitrary Java model schema changes across schema versions, including adding and removing Java types.
 As a result, it's possible for non-primitive fields to have values that don't exist in the new schema. Therefore, it's
 not possible to provide the old values to <a href="../../../io/permazen/annotation/OnVersionChange.html" title="annotation in io.permazen.annotation"><code>&#64;OnVersionChange</code></a> methods in their original form.

 <p>
 Specifically, this can happen in two ways:
 <ul>
 <li>A reference field value refers to an object type that no longer exists; or</li>
 <li>An <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Enum.html?is-external=true" title="class or interface in java.lang"><code>Enum</code></a> field refers to an <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Enum.html?is-external=true" title="class or interface in java.lang"><code>Enum</code></a> type that no longer exists, or whose constants have changed
      (this is really just a special case of the previous scenario: when an <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Enum.html?is-external=true" title="class or interface in java.lang"><code>Enum</code></a> type's constants change
      in any way, the new <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Enum.html?is-external=true" title="class or interface in java.lang"><code>Enum</code></a> is treated as a completely new type).</li>
 </ul>

 <p>
 Therefore, the following special rules apply to the values in the <code>oldValues</code> map:
 <ul>
 <li>For a reference field whose type no longer exists, the referenced object will be an <a href="../../../io/permazen/UntypedJObject.html" title="class in io.permazen"><code>UntypedJObject</code></a>.
 <li>For <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Enum.html?is-external=true" title="class or interface in java.lang"><code>Enum</code></a> fields, old values are always represented as <a href="../../../io/permazen/core/EnumValue.html" title="class in io.permazen.core"><code>EnumValue</code></a> objects.
      For consistency's sake, this is true <i>even if the associated field's type has not changed</i>.</li>
 </ul>

 <p><b>Meta-Annotations</b></p>

 <p>
 This annotation may be configured indirectly as a Spring
 <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/htmlsingle/#beans-meta-annotations">meta-annotation</a>
 when <code>spring-core</code> is on the classpath.</div>
<dl>
<dt><span class="seeLabel">See Also:</span></dt>
<dd><a href="../../../io/permazen/core/FieldType.html#convert-io.permazen.core.FieldType-S-"><code>FieldType.convert()</code></a>, 
<a href="../../../io/permazen/annotation/JField.html#upgradeConversion--"><code>&#64;JField.upgradeConversion()</code></a></dd>
</dl>
</li>
</ul>
</div>
<div class="summary">
<ul class="blockList">
<li class="blockList">
<!-- =========== ANNOTATION TYPE OPTIONAL MEMBER SUMMARY =========== -->
<ul class="blockList">
<li class="blockList"><a name="annotation.type.optional.element.summary">
<!--   -->
</a>
<h3>Optional Element Summary</h3>
<table class="memberSummary" border="0" cellpadding="3" cellspacing="0" summary="Optional Element Summary table, listing optional elements, and an explanation">
<caption><span>Optional Elements</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colFirst" scope="col">Modifier and Type</th>
<th class="colLast" scope="col">Optional Element and Description</th>
</tr>
<tr class="altColor">
<td class="colFirst"><code>int</code></td>
<td class="colLast"><code><span class="memberNameLink"><a href="../../../io/permazen/annotation/OnVersionChange.html#newVersion--">newVersion</a></span></code>
<div class="block">Required new schema version.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><code>int</code></td>
<td class="colLast"><code><span class="memberNameLink"><a href="../../../io/permazen/annotation/OnVersionChange.html#oldVersion--">oldVersion</a></span></code>
<div class="block">Required old schema version.</div>
</td>
</tr>
</table>
</li>
</ul>
</li>
</ul>
</div>
<div class="details">
<ul class="blockList">
<li class="blockList">
<!-- ============ ANNOTATION TYPE MEMBER DETAIL =========== -->
<ul class="blockList">
<li class="blockList"><a name="annotation.type.element.detail">
<!--   -->
</a>
<h3>Element Detail</h3>
<a name="oldVersion--">
<!--   -->
</a>
<ul class="blockList">
<li class="blockList">
<h4>oldVersion</h4>
<pre>public abstract&nbsp;int&nbsp;oldVersion</pre>
<div class="block">Required old schema version.

 <p>
 If this property is set to a positive value, only version changes
 for which the previous schema version equals the specified version will result in notification,
 and the annotated method must have the corresponding parameter omitted. Otherwise notifications
 are delivered for any previous schema version and the <code>oldVersion</code> method parameter is required.

 <p>
 Negative values are not allowed.</div>
<dl>
<dt><span class="returnLabel">Returns:</span></dt>
<dd>old schema version, or zero for no restriction</dd>
</dl>
<dl>
<dt>Default:</dt>
<dd>0</dd>
</dl>
</li>
</ul>
</li>
</ul>
<ul class="blockList">
<li class="blockList"><a name="newVersion--">
<!--   -->
</a>
<ul class="blockListLast">
<li class="blockList">
<h4>newVersion</h4>
<pre>public abstract&nbsp;int&nbsp;newVersion</pre>
<div class="block">Required new schema version.

 <p>
 If this property is set to a positive value, only version changes
 for which the new schema version equals the specified version will result in notification,
 and the annotated method must have the corresponding parameter omitted. Otherwise notifications
 are delivered for any new schema version and the <code>newVersion</code> method parameter is required.

 <p>
 Negative values are not allowed.</div>
<dl>
<dt><span class="returnLabel">Returns:</span></dt>
<dd>new schema version, or zero for no restriction</dd>
</dl>
<dl>
<dt>Default:</dt>
<dd>0</dd>
</dl>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<!-- ========= END OF CLASS DATA ========= -->
<!-- ======= START OF BOTTOM NAVBAR ====== -->
<div class="bottomNav"><a name="navbar.bottom">
<!--   -->
</a>
<div class="skipNav"><a href="#skip.navbar.bottom" title="Skip navigation links">Skip navigation links</a></div>
<a name="navbar.bottom.firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../overview-summary.html">Overview</a></li>
<li><a href="package-summary.html">Package</a></li>
<li class="navBarCell1Rev">Class</li>
<li><a href="class-use/OnVersionChange.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../index-all.html">Index</a></li>
<li><a href="../../../help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../io/permazen/annotation/OnValidate.html" title="annotation in io.permazen.annotation"><span class="typeNameLink">Prev&nbsp;Class</span></a></li>
<li><a href="../../../io/permazen/annotation/PermazenType.html" title="annotation in io.permazen.annotation"><span class="typeNameLink">Next&nbsp;Class</span></a></li>
</ul>
<ul class="navList">
<li><a href="../../../index.html?io/permazen/annotation/OnVersionChange.html" target="_top">Frames</a></li>
<li><a href="OnVersionChange.html" target="_top">No&nbsp;Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_bottom">
<li><a href="../../../allclasses-noframe.html">All&nbsp;Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_bottom");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<div>
<ul class="subNavList">
<li>Summary:&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li>Required&nbsp;|&nbsp;</li>
<li><a href="#annotation.type.optional.element.summary">Optional</a></li>
</ul>
<ul class="subNavList">
<li>Detail:&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li><a href="#annotation.type.element.detail">Element</a></li>
</ul>
</div>
<a name="skip.navbar.bottom">
<!--   -->
</a></div>
<!-- ======== END OF BOTTOM NAVBAR ======= -->
<p class="legalCopy"><small>Copyright &#169; 2022. All rights reserved.</small></p>
</body>
</html>
