<!DOCTYPE HTML>
<html lang="en">
<head>
<!-- Generated by javadoc (17) -->
<title>KVTransaction (Permazen 5.0.0 API)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="description" content="declaration: package: io.permazen.kv, interface: KVTransaction">
<meta name="generator" content="javadoc/ClassWriterImpl">
<link rel="stylesheet" type="text/css" href="../../../stylesheet.css" title="Style">
<link rel="stylesheet" type="text/css" href="../../../script-dir/jquery-ui.min.css" title="Style">
<link rel="stylesheet" type="text/css" href="../../../jquery-ui.overrides.css" title="Style">
<script type="text/javascript" src="../../../script.js"></script>
<script type="text/javascript" src="../../../script-dir/jquery-3.6.1.min.js"></script>
<script type="text/javascript" src="../../../script-dir/jquery-ui.min.js"></script>
</head>
<body class="class-declaration-page">
<script type="text/javascript">var evenRowColor = "even-row-color";
var oddRowColor = "odd-row-color";
var tableTab = "table-tab";
var activeTableTab = "active-table-tab";
var pathtoroot = "../../../";
loadScripts(document, 'script');</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<div class="flex-box">
<header role="banner" class="flex-header">
<nav role="navigation">
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="top-nav" id="navbar-top">
<div class="skip-nav"><a href="#skip-navbar-top" title="Skip navigation links">Skip navigation links</a></div>
<ul id="navbar-top-firstrow" class="nav-list" title="Navigation">
<li><a href="../../../index.html">Overview</a></li>
<li><a href="package-summary.html">Package</a></li>
<li class="nav-bar-cell1-rev">Class</li>
<li><a href="class-use/KVTransaction.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../index-all.html">Index</a></li>
<li><a href="../../../help-doc.html#class">Help</a></li>
</ul>
</div>
<div class="sub-nav">
<div>
<ul class="sub-nav-list">
<li>Summary:&nbsp;</li>
<li>Nested&nbsp;|&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li>Constr&nbsp;|&nbsp;</li>
<li><a href="#method-summary">Method</a></li>
</ul>
<ul class="sub-nav-list">
<li>Detail:&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li>Constr&nbsp;|&nbsp;</li>
<li><a href="#method-detail">Method</a></li>
</ul>
</div>
<div class="nav-list-search"><label for="search-input">SEARCH:</label>
<input type="text" id="search-input" value="search" disabled="disabled">
<input type="reset" id="reset-button" value="reset" disabled="disabled">
</div>
</div>
<!-- ========= END OF TOP NAVBAR ========= -->
<span class="skip-nav" id="skip-navbar-top"></span></nav>
</header>
<div class="flex-content">
<main role="main">
<!-- ======== START OF CLASS DATA ======== -->
<div class="header">
<div class="sub-title"><span class="package-label-in-type">Package</span>&nbsp;<a href="package-summary.html">io.permazen.kv</a></div>
<h1 title="Interface KVTransaction" class="title">Interface KVTransaction</h1>
</div>
<section class="class-description" id="class-description">
<dl class="notes">
<dt>All Superinterfaces:</dt>
<dd><code><a href="KVStore.html" title="interface in io.permazen.kv">KVStore</a></code></dd>
</dl>
<dl class="notes">
<dt>All Known Implementing Classes:</dt>
<dd><code><a href="array/ArrayKVTransaction.html" title="class in io.permazen.kv.array">ArrayKVTransaction</a></code>, <code><a href="bdb/BerkeleyKVTransaction.html" title="class in io.permazen.kv.bdb">BerkeleyKVTransaction</a></code>, <code><a href="mvcc/BranchedKVTransaction.html" title="class in io.permazen.kv.mvcc">BranchedKVTransaction</a></code>, <code><a href="lmdb/ByteArrayLMDBKVTransaction.html" title="class in io.permazen.kv.lmdb">ByteArrayLMDBKVTransaction</a></code>, <code><a href="caching/CachingKVTransaction.html" title="class in io.permazen.kv.caching">CachingKVTransaction</a></code>, <code><a href="raft/fallback/FallbackKVTransaction.html" title="class in io.permazen.kv.raft.fallback">FallbackKVTransaction</a></code>, <code><a href="fdb/FoundationKVTransaction.html" title="class in io.permazen.kv.fdb">FoundationKVTransaction</a></code>, <code><a href="leveldb/LevelDBKVTransaction.html" title="class in io.permazen.kv.leveldb">LevelDBKVTransaction</a></code>, <code><a href="lmdb/LMDBKVTransaction.html" title="class in io.permazen.kv.lmdb">LMDBKVTransaction</a></code>, <code><a href="mvstore/MVStoreKVTransaction.html" title="class in io.permazen.kv.mvstore">MVStoreKVTransaction</a></code>, <code><a href="util/PrefixKVTransaction.html" title="class in io.permazen.kv.util">PrefixKVTransaction</a></code>, <code><a href="raft/RaftKVTransaction.html" title="class in io.permazen.kv.raft">RaftKVTransaction</a></code>, <code><a href="simple/SimpleKVTransaction.html" title="class in io.permazen.kv.simple">SimpleKVTransaction</a></code>, <code><a href="mvcc/SnapshotKVTransaction.html" title="class in io.permazen.kv.mvcc">SnapshotKVTransaction</a></code>, <code><a href="spanner/SpannerKVTransaction.html" title="class in io.permazen.kv.spanner">SpannerKVTransaction</a></code>, <code><a href="sql/SQLKVTransaction.html" title="class in io.permazen.kv.sql">SQLKVTransaction</a></code>, <code><a href="simple/XMLKVTransaction.html" title="class in io.permazen.kv.simple">XMLKVTransaction</a></code>, <code><a href="xodus/XodusKVTransaction.html" title="class in io.permazen.kv.xodus">XodusKVTransaction</a></code></dd>
</dl>
<hr>
<div class="type-signature"><span class="modifiers">public interface </span><span class="element-name type-name-label">KVTransaction</span><span class="extends-implements">
extends <a href="KVStore.html" title="interface in io.permazen.kv">KVStore</a></span></div>
<div class="block"><a href="KVDatabase.html" title="interface in io.permazen.kv"><code>KVDatabase</code></a> transaction API.

 <p>
 Provides a transactional view of a <a href="KVStore.html" title="interface in io.permazen.kv"><code>KVStore</code></a>.

 <p>
 Instances may throw <a href="KVTransactionException.html" title="class in io.permazen.kv"><code>KVTransactionException</code></a> during any operation if the transaction cannot be continued.
 In particular, <a href="StaleKVTransactionException.html" title="class in io.permazen.kv"><code>StaleKVTransactionException</code></a> is thrown by a transaction that is no longer open, and
 <a href="RetryKVTransactionException.html" title="class in io.permazen.kv"><code>RetryKVTransactionException</code></a> is thrown when the transaction should be retried due to a transient
 problem (such as a write conflict with another transaction).

 <p>
 When <a href="RetryKVTransactionException.html" title="class in io.permazen.kv"><code>RetryKVTransactionException</code></a> is thrown by <a href="#commit()"><code>commit()</code></a>, the transaction may have actually been committed.
 Therefore, transactions should be written to be idempotent.

 <p>
 No matter what state it is in, instances must support invoking <a href="#rollback()"><code>rollback()</code></a> at any time.

 <p>
 If an instance throws a <a href="KVTransactionException.html" title="class in io.permazen.kv"><code>KVTransactionException</code></a>, the transaction should be implicitly rolled back.
 Any subsequent operation other than <a href="#rollback()"><code>rollback()</code></a> should throw <a href="StaleKVTransactionException.html" title="class in io.permazen.kv"><code>StaleKVTransactionException</code></a>.

 <p>
 Except for <a href="#rollback()"><code>rollback()</code></a> and methods that just query status, implementations must throw <a href="StaleKVTransactionException.html" title="class in io.permazen.kv"><code>StaleKVTransactionException</code></a>
 if <a href="#commit()"><code>commit()</code></a> or <a href="#rollback()"><code>rollback()</code></a> has already been invoked, or if the <a href="KVTransaction.html" title="interface in io.permazen.kv"><code>KVTransaction</code></a> instance is no longer usable
 for some other reason. In particular, implementations should throw <a href="KVTransactionTimeoutException.html" title="class in io.permazen.kv"><code>KVTransactionTimeoutException</code></a> if an operation
 is attempted on a transaction that has been held open past some maximum allowed time limit.

 <p>
 Implementations are responsible for ensuring modifications to <code>byte[]</code> arrays after method
 invocations do no harm. This usually means <code>byte[]</code> array parameters and return values must be copied.

 <p>
 Implementations are not required to support accessing keys that start with <code>0xff</code>,
 and if not may throw <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/IllegalArgumentException.html" title="class or interface in java.lang" class="external-link"><code>IllegalArgumentException</code></a> if such keys are accessed.

 <p>
 Note: for some implementations, the data read from a transaction that is never <a href="#commit()"><code>commit()</code></a>'ed is
 not guaranteed to be up to date.</div>
</section>
<section class="summary">
<ul class="summary-list">
<!-- ========== METHOD SUMMARY =========== -->
<li>
<section class="method-summary" id="method-summary">
<h2>Method Summary</h2>
<div id="method-summary-table">
<div class="table-tabs" role="tablist" aria-orientation="horizontal"><button id="method-summary-table-tab0" role="tab" aria-selected="true" aria-controls="method-summary-table.tabpanel" tabindex="0" onkeydown="switchTab(event)" onclick="show('method-summary-table', 'method-summary-table', 3)" class="active-table-tab">All Methods</button><button id="method-summary-table-tab2" role="tab" aria-selected="false" aria-controls="method-summary-table.tabpanel" tabindex="-1" onkeydown="switchTab(event)" onclick="show('method-summary-table', 'method-summary-table-tab2', 3)" class="table-tab">Instance Methods</button><button id="method-summary-table-tab3" role="tab" aria-selected="false" aria-controls="method-summary-table.tabpanel" tabindex="-1" onkeydown="switchTab(event)" onclick="show('method-summary-table', 'method-summary-table-tab3', 3)" class="table-tab">Abstract Methods</button><button id="method-summary-table-tab5" role="tab" aria-selected="false" aria-controls="method-summary-table.tabpanel" tabindex="-1" onkeydown="switchTab(event)" onclick="show('method-summary-table', 'method-summary-table-tab5', 3)" class="table-tab">Default Methods</button></div>
<div id="method-summary-table.tabpanel" role="tabpanel">
<div class="summary-table three-column-summary" aria-labelledby="method-summary-table-tab0">
<div class="table-header col-first">Modifier and Type</div>
<div class="table-header col-second">Method</div>
<div class="table-header col-last">Description</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab3"><code>void</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab3"><code><a href="#commit()" class="member-name-link">commit</a>()</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab3">
<div class="block">Commit this transaction.</div>
</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab3"><code><a href="KVDatabase.html" title="interface in io.permazen.kv">KVDatabase</a></code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab3"><code><a href="#getKVDatabase()" class="member-name-link">getKVDatabase</a>()</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab3">
<div class="block">Get the <a href="KVDatabase.html" title="interface in io.permazen.kv"><code>KVDatabase</code></a> with which this instance is associated.</div>
</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab3"><code>boolean</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab3"><code><a href="#isReadOnly()" class="member-name-link">isReadOnly</a>()</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab3">
<div class="block">Determine whether this transaction is read-only.</div>
</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab3"><code><a href="CloseableKVStore.html" title="interface in io.permazen.kv">CloseableKVStore</a></code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab3"><code><a href="#readOnlySnapshot()" class="member-name-link">readOnlySnapshot</a>()</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab3">
<div class="block">Create a read-only snapshot of the database content represented by this transaction.</div>
</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab3"><code>void</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab3"><code><a href="#rollback()" class="member-name-link">rollback</a>()</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab3">
<div class="block">Cancel this transaction, if not already canceled.</div>
</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab3"><code>void</code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab3"><code><a href="#setReadOnly(boolean)" class="member-name-link">setReadOnly</a><wbr>(boolean&nbsp;readOnly)</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab3">
<div class="block">Enable or disable read-only mode.</div>
</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab3"><code>void</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab3"><code><a href="#setTimeout(long)" class="member-name-link">setTimeout</a><wbr>(long&nbsp;timeout)</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab3">
<div class="block">Change the timeout for this transaction from its default value (optional operation).</div>
</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab3"><code><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/Future.html" title="class or interface in java.util.concurrent" class="external-link">Future</a>&lt;<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/Void.html" title="class or interface in java.lang" class="external-link">Void</a>&gt;</code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab3"><code><a href="#watchKey(byte%5B%5D)" class="member-name-link">watchKey</a><wbr>(byte[]&nbsp;key)</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab3">
<div class="block">Watch a key to monitor for changes in its value.</div>
</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab5"><code>default void</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab5"><code><a href="#withWeakConsistency(java.lang.Runnable)" class="member-name-link">withWeakConsistency</a><wbr>(<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/Runnable.html" title="class or interface in java.lang" class="external-link">Runnable</a>&nbsp;action)</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab5">
<div class="block">Apply weaker transaction consistency while performing the given action, if supported.</div>
</div>
</div>
</div>
</div>
<div class="inherited-list">
<h3 id="methods-inherited-from-class-io.permazen.kv.KVStore">Methods inherited from interface&nbsp;io.permazen.kv.<a href="KVStore.html" title="interface in io.permazen.kv">KVStore</a></h3>
<code><a href="KVStore.html#adjustCounter(byte%5B%5D,long)">adjustCounter</a>, <a href="KVStore.html#apply(io.permazen.kv.mvcc.Mutations)">apply</a>, <a href="KVStore.html#decodeCounter(byte%5B%5D)">decodeCounter</a>, <a href="KVStore.html#encodeCounter(long)">encodeCounter</a>, <a href="KVStore.html#get(byte%5B%5D)">get</a>, <a href="KVStore.html#getAtLeast(byte%5B%5D,byte%5B%5D)">getAtLeast</a>, <a href="KVStore.html#getAtMost(byte%5B%5D,byte%5B%5D)">getAtMost</a>, <a href="KVStore.html#getRange(byte%5B%5D,byte%5B%5D)">getRange</a>, <a href="KVStore.html#getRange(byte%5B%5D,byte%5B%5D,boolean)">getRange</a>, <a href="KVStore.html#getRange(io.permazen.kv.KeyRange)">getRange</a>, <a href="KVStore.html#put(byte%5B%5D,byte%5B%5D)">put</a>, <a href="KVStore.html#remove(byte%5B%5D)">remove</a>, <a href="KVStore.html#removeRange(byte%5B%5D,byte%5B%5D)">removeRange</a>, <a href="KVStore.html#removeRange(io.permazen.kv.KeyRange)">removeRange</a></code></div>
</section>
</li>
</ul>
</section>
<section class="details">
<ul class="details-list">
<!-- ============ METHOD DETAIL ========== -->
<li>
<section class="method-details" id="method-detail">
<h2>Method Details</h2>
<ul class="member-list">
<li>
<section class="detail" id="getKVDatabase()">
<h3>getKVDatabase</h3>
<div class="member-signature"><span class="return-type"><a href="KVDatabase.html" title="interface in io.permazen.kv">KVDatabase</a></span>&nbsp;<span class="element-name">getKVDatabase</span>()</div>
<div class="block">Get the <a href="KVDatabase.html" title="interface in io.permazen.kv"><code>KVDatabase</code></a> with which this instance is associated.</div>
<dl class="notes">
<dt>Returns:</dt>
<dd>associated database</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="setTimeout(long)">
<h3>setTimeout</h3>
<div class="member-signature"><span class="return-type">void</span>&nbsp;<span class="element-name">setTimeout</span><wbr><span class="parameters">(long&nbsp;timeout)</span></div>
<div class="block">Change the timeout for this transaction from its default value (optional operation).</div>
<dl class="notes">
<dt>Parameters:</dt>
<dd><code>timeout</code> - transaction timeout in milliseconds, or zero for unlimited</dd>
<dt>Throws:</dt>
<dd><code><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/UnsupportedOperationException.html" title="class or interface in java.lang" class="external-link">UnsupportedOperationException</a></code> - if this transaction does not support timeouts</dd>
<dd><code><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/IllegalArgumentException.html" title="class or interface in java.lang" class="external-link">IllegalArgumentException</a></code> - if <code>timeout</code> is negative</dd>
<dd><code><a href="StaleKVTransactionException.html" title="class in io.permazen.kv">StaleKVTransactionException</a></code> - if this transaction is no longer usable</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="isReadOnly()">
<h3>isReadOnly</h3>
<div class="member-signature"><span class="return-type">boolean</span>&nbsp;<span class="element-name">isReadOnly</span>()</div>
<div class="block">Determine whether this transaction is read-only.

 <p>
 Default is false.</div>
<dl class="notes">
<dt>Returns:</dt>
<dd>true if this instance is read-only</dd>
<dt>Throws:</dt>
<dd><code><a href="StaleKVTransactionException.html" title="class in io.permazen.kv">StaleKVTransactionException</a></code> - if this transaction is no longer usable</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="setReadOnly(boolean)">
<h3>setReadOnly</h3>
<div class="member-signature"><span class="return-type">void</span>&nbsp;<span class="element-name">setReadOnly</span><wbr><span class="parameters">(boolean&nbsp;readOnly)</span></div>
<div class="block">Enable or disable read-only mode.

 <p>
 Read-only transactions allow mutations, but all changes are discarded on <a href="#commit()"><code>commit()</code></a>.

 <p>
 Some implementations may impose one or more of the following restrictions on this method:
 <ul>
  <li><a href="#setReadOnly(boolean)"><code>setReadOnly()</code></a> may only be invoked prior to accessing data;</li>
  <li><a href="#setReadOnly(boolean)"><code>setReadOnly()</code></a> may only be invoked prior to mutating data; and/or</li>
  <li>Once set to read-only, a transaction may not be set back to read-write</li>
 </ul>
 If one of the above constraints is violated, an <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/IllegalStateException.html" title="class or interface in java.lang" class="external-link"><code>IllegalStateException</code></a> is thrown.

 <p>
 Note: for some implementations, the data read from a transaction that is never <a href="#commit()"><code>commit()</code></a>'ed is
 not guaranteed to be up to date, even if that transaction is read-only.

 <p>
 Default is false.</div>
<dl class="notes">
<dt>Parameters:</dt>
<dd><code>readOnly</code> - read-only setting</dd>
<dt>Throws:</dt>
<dd><code><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/IllegalStateException.html" title="class or interface in java.lang" class="external-link">IllegalStateException</a></code> - if the implementation doesn't support changing read-only status at this time</dd>
<dd><code><a href="StaleKVTransactionException.html" title="class in io.permazen.kv">StaleKVTransactionException</a></code> - if this transaction is no longer usable</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="watchKey(byte[])">
<h3>watchKey</h3>
<div class="member-signature"><span class="return-type"><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/Future.html" title="class or interface in java.util.concurrent" class="external-link">Future</a>&lt;<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/Void.html" title="class or interface in java.lang" class="external-link">Void</a>&gt;</span>&nbsp;<span class="element-name">watchKey</span><wbr><span class="parameters">(byte[]&nbsp;key)</span></div>
<div class="block">Watch a key to monitor for changes in its value.

 <p>
 When this method is invoked, <code>key</code>'s current value (if any) as read by this transaction is remembered. The returned
 <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/Future.html" title="class or interface in java.util.concurrent" class="external-link"><code>Future</code></a> completes if and when a different value for <code>key</code> is subsequently committed by some transaction,
 including possibly this one. This includes creation or deletion of the key.

 <p>
 Key watches outlive the transaction in which they are created, persisting until they complete or are
 <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/Future.html#cancel(boolean)" title="class or interface in java.util.concurrent" class="external-link"><code>cancel()</code></a>'ed. When a <a href="KVDatabase.html" title="interface in io.permazen.kv"><code>KVDatabase</code></a> is <a href="KVDatabase.html#stop()"><code>KVDatabase.stop()</code></a>'ed, all outstanding
 key watches are implicitly <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/Future.html#cancel(boolean)" title="class or interface in java.util.concurrent" class="external-link"><code>cancel()</code></a>'ed.

 <p><b>Caveats</b></p>

 <p>
 Key watches are not without overhead; applications should avoid overuse. For example, consider creating a
 single key that is used to consolidate modifications to some set of keys; at the Permazen layer, modification
 to multiple objects and/or fields can detected and consolidated using an
 <a href="../annotation/OnChange.html" title="annotation interface in io.permazen.annotation"><code>&#64;OnChange</code></a> method that increments a single <a href="../Counter.html" title="class in io.permazen"><code>Counter</code></a>
 field, whose key is then watched (to determine the key corresponding to a Java model object field, use
 <a href="../PermazenField.html#getKey(io.permazen.PermazenObject)"><code>PermazenField.getKey()</code></a>).

 <p>
 Conceptually, detection of changes behaves as if by a background thread that periodically creates a new transaction
 and reads the key's value (the actual implementation will likely be more efficient). This means a change that is
 quickly reverted could be missed, and that multiple changes could occur before notification. In addition, spurious
 notifications may occur, where the key's value has not changed.

 <p>
 A key watch is only guaranteed to be valid if the transaction in which it was created successfully commits.
 In particular, nothing is specified about how or whether <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/Future.html" title="class or interface in java.util.concurrent" class="external-link"><code>Future</code></a>s associated with failed transactions complete,
 so the <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/Future.html" title="class or interface in java.util.concurrent" class="external-link"><code>Future</code></a>s returned by this method should not be relied on until after a successful commit (perhaps with
 the help of a <a href="../core/Transaction.html#addCallback(io.permazen.core.Transaction.Callback)">transaction callback</a>).

 <p>
 Key watch support is optional; instances that don't support key watches throw <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/UnsupportedOperationException.html" title="class or interface in java.lang" class="external-link"><code>UnsupportedOperationException</code></a>.
 Some implementations may only support watching a key that already exists.

 <p>
 Note: many <a href="KVDatabase.html" title="interface in io.permazen.kv"><code>KVDatabase</code></a> implementations actually return a
 <a href="https://guava.dev/releases/33.2.1-jre/api/docs/com/google/common/util/concurrent/ListenableFuture.html" title="class or interface in com.google.common.util.concurrent" class="external-link"><code>ListenableFuture</code></a>. However, listeners must not perform any
 long running or blocking operations. Also, because the semantics of <a href="RetryKVTransactionException.html" title="class in io.permazen.kv"><code>RetryKVTransactionException</code></a> allow for
 the possibility that the transaction actually did commit, "duplicate" listener notifications could occur.

 <p>
 Key watch <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/Future.html" title="class or interface in java.util.concurrent" class="external-link"><code>Future</code></a>s that have not completed yet, but are no longer needed, must be <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/Future.html#cancel(boolean)" title="class or interface in java.util.concurrent" class="external-link"><code>cancel()</code></a>'ed
 to avoid memory leaks.

 <p>
 Key watch support is indepdendent of whether the transaction is <a href="#setReadOnly(boolean)">read-only</a>.</div>
<dl class="notes">
<dt>Parameters:</dt>
<dd><code>key</code> - the key to watch</dd>
<dt>Returns:</dt>
<dd>a <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/Future.html" title="class or interface in java.util.concurrent" class="external-link"><code>Future</code></a> that returns <code>key</code> when the value associated with <code>key</code> is modified</dd>
<dt>Throws:</dt>
<dd><code><a href="StaleKVTransactionException.html" title="class in io.permazen.kv">StaleKVTransactionException</a></code> - if this transaction is no longer usable</dd>
<dd><code><a href="RetryKVTransactionException.html" title="class in io.permazen.kv">RetryKVTransactionException</a></code> - if this transaction must be retried and is no longer usable</dd>
<dd><code><a href="KVDatabaseException.html" title="class in io.permazen.kv">KVDatabaseException</a></code> - if an unexpected error occurs</dd>
<dd><code><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/UnsupportedOperationException.html" title="class or interface in java.lang" class="external-link">UnsupportedOperationException</a></code> - if this instance does not support key watches</dd>
<dd><code><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/IllegalArgumentException.html" title="class or interface in java.lang" class="external-link">IllegalArgumentException</a></code> - if <code>key</code> starts with <code>0xff</code> and such keys are not supported</dd>
<dd><code><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/IllegalArgumentException.html" title="class or interface in java.lang" class="external-link">IllegalArgumentException</a></code> - if <code>key</code> is null</dd>
<dt>See Also:</dt>
<dd>
<ul class="see-list">
<li><a href="../PermazenTransaction.html#getKey(io.permazen.PermazenObject)"><code>PermazenTransaction.getKey()</code></a></li>
<li><a href="../PermazenField.html#getKey(io.permazen.PermazenObject)"><code>PermazenField.getKey()</code></a></li>
</ul>
</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="commit()">
<h3>commit</h3>
<div class="member-signature"><span class="return-type">void</span>&nbsp;<span class="element-name">commit</span>()</div>
<div class="block">Commit this transaction.

 <p>
 Note that if this method throws a <a href="RetryKVTransactionException.html" title="class in io.permazen.kv"><code>RetryKVTransactionException</code></a>,
 the transaction was either successfully committed or rolled back. In either case,
 this instance is no longer usable.

 <p>
 Note also for some implementations, even read-only transactions must be <a href="#commit()"><code>commit()</code></a>'ed in order for the
 data accessed during the transaction to be guaranteed to be up to date.</div>
<dl class="notes">
<dt>Throws:</dt>
<dd><code><a href="StaleKVTransactionException.html" title="class in io.permazen.kv">StaleKVTransactionException</a></code> - if this transaction is no longer usable</dd>
<dd><code><a href="RetryKVTransactionException.html" title="class in io.permazen.kv">RetryKVTransactionException</a></code> - if this transaction must be retried and is no longer usable</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="rollback()">
<h3>rollback</h3>
<div class="member-signature"><span class="return-type">void</span>&nbsp;<span class="element-name">rollback</span>()</div>
<div class="block">Cancel this transaction, if not already canceled.

 <p>
 After this method returns, this instance is no longer usable.

 <p>
 Note: for some implementations, rolling back a transaction invalidates guarantees about the the data read
 during the transaction being up to date, even if the transaction was <a href="#setReadOnly(boolean)"><code>setReadOnly()</code></a>.

 <p>
 This method may be invoked at any time, even after a previous invocation of
 <a href="#commit()"><code>commit()</code></a> or <a href="#rollback()"><code>rollback()</code></a>, in which case the invocation will be ignored.
 In particular, this method must <b>not</b> throw <a href="StaleKVTransactionException.html" title="class in io.permazen.kv"><code>StaleKVTransactionException</code></a>.</div>
</section>
</li>
<li>
<section class="detail" id="withWeakConsistency(java.lang.Runnable)">
<h3>withWeakConsistency</h3>
<div class="member-signature"><span class="modifiers">default</span>&nbsp;<span class="return-type">void</span>&nbsp;<span class="element-name">withWeakConsistency</span><wbr><span class="parameters">(<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/Runnable.html" title="class or interface in java.lang" class="external-link">Runnable</a>&nbsp;action)</span></div>
<div class="block">Apply weaker transaction consistency while performing the given action, if supported.

 <p>
 Some implementations support reads with weaker consistency guarantees. These reads generate fewer transaction
 conflicts but return possibly out-of-date information. Depending on the implementation, when operating in this
 mode writes may not be supported and may generate an <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/IllegalStateException.html" title="class or interface in java.lang" class="external-link"><code>IllegalStateException</code></a> or just be ignored.

 <p>
 The weaker consistency is only applied for the current thread, and it ends when this method returns.

 <p>
 <b>This method is for experts only</b>; inappropriate use can result in a corrupted database.
 You should not make any changes to the database after this method returns based on any information
 read by the <code>action</code>.

 <p>
 The implementation in <a href="KVTransaction.html" title="interface in io.permazen.kv"><code>KVTransaction</code></a> just performs <code>action</code> normally.</div>
<dl class="notes">
<dt>Parameters:</dt>
<dd><code>action</code> - the action to perform</dd>
<dt>Throws:</dt>
<dd><code><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/IllegalArgumentException.html" title="class or interface in java.lang" class="external-link">IllegalArgumentException</a></code> - if <code>action</code> is null</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="readOnlySnapshot()">
<h3>readOnlySnapshot</h3>
<div class="member-signature"><span class="return-type"><a href="CloseableKVStore.html" title="interface in io.permazen.kv">CloseableKVStore</a></span>&nbsp;<span class="element-name">readOnlySnapshot</span>()</div>
<div class="block">Create a read-only snapshot of the database content represented by this transaction.

 <p>
 The returned <a href="CloseableKVStore.html" title="interface in io.permazen.kv"><code>CloseableKVStore</code></a> should be treated as read-only. It may not actually be read-only,
 but if it's not, then any changes should have no effect on this instance. The returned <a href="CloseableKVStore.html" title="interface in io.permazen.kv"><code>CloseableKVStore</code></a>
 must be completely independent from this transaction (subsequent changes to either one do not affect the other).

 <p>
 Note: as with any other information extracted from a <a href="KVTransaction.html" title="interface in io.permazen.kv"><code>KVTransaction</code></a>, the returned content should not be
 considered valid until this transaction has been successfully committed.

 <p>
 The returned <a href="CloseableKVStore.html" title="interface in io.permazen.kv"><code>CloseableKVStore</code></a> should be promply <a href="CloseableKVStore.html#close()"><code>close()</code></a>'d when no longer
 needed to release any underlying resources. In particular, the caller must ensure that the <a href="CloseableKVStore.html" title="interface in io.permazen.kv"><code>CloseableKVStore</code></a>
 is <a href="CloseableKVStore.html#close()"><code>close()</code></a>'d even if this transaction's commit fails. This may require
 adding a transaction synchronization callback, etc.

 <p>
 This is an optional method; only some underlying key/value store technologies can efficiently support it.
 Implementations should throw <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/UnsupportedOperationException.html" title="class or interface in java.lang" class="external-link"><code>UnsupportedOperationException</code></a> if not supported.</div>
<dl class="notes">
<dt>Returns:</dt>
<dd>independent, read-only copy of this transaction's entire database content</dd>
<dt>Throws:</dt>
<dd><code><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/UnsupportedOperationException.html" title="class or interface in java.lang" class="external-link">UnsupportedOperationException</a></code> - if this method is not supported</dd>
<dd><code><a href="StaleKVTransactionException.html" title="class in io.permazen.kv">StaleKVTransactionException</a></code> - if this transaction is no longer usable</dd>
<dd><code><a href="RetryKVTransactionException.html" title="class in io.permazen.kv">RetryKVTransactionException</a></code> - if this transaction must be retried and is no longer usable</dd>
</dl>
</section>
</li>
</ul>
</section>
</li>
</ul>
</section>
<!-- ========= END OF CLASS DATA ========= -->
</main>
<footer role="contentinfo">
<hr>
<p class="legal-copy"><small>Copyright &#169; 2024. All rights reserved.</small></p>
</footer>
</div>
</div>
</body>
</html>
