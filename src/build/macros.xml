<!-- $Id$ -->

<project name="build-macros"
  xmlns:antcontrib="urn:net.sf.antcontrib"
  xmlns:dellroad="urn:org.dellroad.ant"
  xmlns:ivy="urn:org.apache.ivy.ant"
  xmlns:testng="urn:org.testng"
  xmlns:cobertura="urn:net.sf.cobertura"
  xmlns:findbugs="urn:edu.umd.cs.findbugs"
  xmlns:checkstyle="urn:net.sf.checkstyle">

<!--
    Instructions for includers of this file:

    - Define "javac.classpath" target finding classes required for javac and unit test compilation
    - Define "unittest.classpath" target finding additional classes required for unit test execution
    - Override "javac.compiler.flags" if desired

-->

    <!-- Project should override this as necessary -->
    <property name="javac.compiler.flags" value="-Xlint:all"/>

<!--
        ************* DETERMINE BASE DIRECTORY ****************
-->

    <dirname property="build.macros.dir" file="${ant.file.build-macros}"/>

<!--
        ************* MACRO FOR FINDING ANT LIBRARIES ****************
-->

    <macrodef uri="urn:org.dellroad.ant" name="findantlib">
        <attribute name="property" description="Name of property to set"/>
        <attribute name="file" description="Name of library to look for"/>
        <sequential>
            <condition property="@{property}" value="/usr/share/java/@{file}">
                <and>
                    <not>
                        <isset property="@{property}"/>
                    </not>
                    <available file="/usr/share/java/@{file}" type="file"/>
                </and>
            </condition>
            <condition property="@{property}" value="${ant.library.dir}/@{file}">
                <and>
                    <not>
                        <isset property="@{property}"/>
                    </not>
                    <available file="${ant.library.dir}/@{file}" type="file"/>
                </and>
            </condition>
            <fail message="ERROR: can't find @{file}; please install in /usr/share/java or ${ant.library.dir}, or pass -D@{property}=... on the command line">
                <condition>
                    <not>
                        <isset property="@{property}"/>
                    </not>
                </condition>
            </fail>
            <fail message="ERROR: invalid value for ${@{property}}">
                <condition>
                    <not>
                        <available file="${@{property}}" type="file"/>
                    </not>
                </condition>
            </fail>
        </sequential>
    </macrodef>

<!--
        ************* DEFINE ANTCONTRIB AND IVY STUFF ****************
-->

    <!-- Import ivy ant tasks -->
    <dellroad:findantlib property="ivy.jar" file="ivy.jar"/>
    <taskdef uri="urn:org.apache.ivy.ant" resource="org/apache/ivy/ant/antlib.xml" classpath="${ivy.jar}"/>

    <!-- Import ant-contrib ant tasks -->
    <dellroad:findantlib property="ant-contrib.jar" file="ant-contrib.jar"/>
    <taskdef uri="urn:net.sf.antcontrib" resource="net/sf/antcontrib/antcontrib.properties" classpath="${ant-contrib.jar}"/>

<!--
        ************* IVY CONFIGURATION ****************
-->

    <!--
        Macro for resolving a classpath by naming the module, etc. directly.
        Defines classpath "@{pathid}" and sets property "@{pathid}.resolved".
    -->
    <macrodef uri="urn:org.dellroad.ant" name="ivymodpath">
        <attribute name="pathid" description="Classpath reference id to define"/>
        <attribute name="org" description="Module organisation name"/>
        <attribute name="mod" description="Module module name"/>
        <attribute name="rev" description="Module revision"/>
        <attribute name="conf" default="default" description="Name of the ivy configuration to resolve"/>
        <attribute name="type" default="jar" description="Type of artifact to resolve"/>
        <attribute name="settingsRef" default="build-macros-ivy-settings" description="Reference to ivy settings"/>
        <attribute name="transitive" default="true" description="Whether to resolve dependencies transitively"/>
        <attribute name="log" default="download-only" description="When to log activity"/>
        <sequential>
            <ivy:resolve settingsRef="@{settingsRef}" organisation="@{org}" module="@{mod}" revision="@{rev}"
              type="@{type}" inline="true" transitive="@{transitive}" conf="@{conf}" log="@{log}"/>
            <ivy:cachepath settingsRef="@{settingsRef}" organisation="@{org}" module="@{mod}" revision="@{rev}"
              type="@{type}" inline="true" transitive="@{transitive}" conf="@{conf}" log="@{log}" pathid="@{pathid}"/>
            <property name="@{pathid}.resolved" value="true"/>
        </sequential>
    </macrodef>

    <!--
        Macro for resolving a classpath using a named configuration in ivy.xml.
        Defines classpath "@{pathid}" and sets property "@{pathid}.resolved".
    -->
    <macrodef uri="urn:org.dellroad.ant" name="ivypath">
        <attribute name="pathid" description="Classpath reference id to define"/>
        <attribute name="ivyfile" default="${basedir}/src/ivy/ivy.xml" description="ivy.xml defining the named configuration"/>
        <attribute name="conf" description="Name of the ivy configuration to resolve"/>
        <attribute name="type" default="jar" description="Type of artifact to resolve"/>
        <attribute name="settingsRef" default="build-macros-ivy-settings" description="Reference to ivy settings"/>
        <attribute name="transitive" default="true" description="Whether to resolve dependencies transitively"/>
        <attribute name="log" default="download-only" description="When to log activity"/>
        <sequential>
            <ivy:resolve file="@{ivyfile}" settingsRef="@{settingsRef}" type="@{type}"
              transitive="@{transitive}" conf="@{conf}" log="@{log}"/>
            <ivy:cachepath file="@{ivyfile}" settingsRef="@{settingsRef}" type="@{type}"
              transitive="@{transitive}" conf="@{conf}" log="@{log}" pathid="@{pathid}"/>
            <property name="@{pathid}.resolved" value="true"/>
        </sequential>
    </macrodef>

    <!--
        Macro for resolving a fileset using a named configuration in ivy.xml.
        Defines fileset "@{setid}" and sets property "@{setid}.resolved".
    -->
    <macrodef uri="urn:org.dellroad.ant" name="ivyfileset">
        <attribute name="setid" description="Fileset reference id to define"/>
        <attribute name="ivyfile" default="${basedir}/src/ivy/ivy.xml" description="ivy.xml defining the named configuration"/>
        <attribute name="conf" description="Name of the ivy configuration to resolve"/>
        <attribute name="type" default="jar" description="Type of artifact to resolve"/>
        <attribute name="settingsRef" default="build-macros-ivy-settings" description="Reference to ivy settings"/>
        <attribute name="transitive" default="true" description="Whether to resolve dependencies transitively"/>
        <attribute name="log" default="download-only" description="When to log activity"/>
        <sequential>
            <ivy:resolve file="@{ivyfile}" settingsRef="@{settingsRef}" type="@{type}"
              transitive="@{transitive}" conf="@{conf}" log="@{log}"/>
            <ivy:cachefileset file="@{ivyfile}" settingsRef="@{settingsRef}" type="@{type}"
              transitive="@{transitive}" conf="@{conf}" log="@{log}" setid="@{setid}"/>
            <property name="@{setid}.resolved" value="true"/>
        </sequential>
    </macrodef>

    <!--
        Macro for retrieving ivy artifacts using a named configuration in ivy.xml.
    -->
    <macrodef uri="urn:org.dellroad.ant" name="ivyput">
        <attribute name="pattern" description="Ivy pattern for artifact destination"/>
        <attribute name="ivyfile" default="${basedir}/src/ivy/ivy.xml" description="ivy.xml defining the named configuration"/>
        <attribute name="conf" description="Name of the ivy configuration to resolve"/>
        <attribute name="type" default="jar" description="Type of artifact to resolve"/>
        <attribute name="settingsRef" default="build-macros-ivy-settings" description="Reference to ivy settings"/>
        <attribute name="transitive" default="true" description="Whether to resolve dependencies transitively"/>
        <attribute name="log" default="download-only" description="When to log activity"/>
        <sequential>
            <ivy:resolve file="@{ivyfile}" settingsRef="@{settingsRef}" type="@{type}"
              transitive="@{transitive}" conf="@{conf}" log="@{log}"/>
            <ivy:retrieve file="@{ivyfile}" settingsRef="@{settingsRef}" type="@{type}"
              transitive="@{transitive}" conf="@{conf}" log="@{log}" pattern="@{pattern}"/>
        </sequential>
    </macrodef>

    <!--
        Macro for retrieving artifacts by naming the module, etc. directly.
        Does not require an ivy.xml file.
    -->
    <macrodef uri="urn:org.dellroad.ant" name="ivymodget">
        <attribute name="pattern" description="Ivy pattern for artifact destination"/>
        <attribute name="org" description="Module organisation name"/>
        <attribute name="mod" description="Module module name"/>
        <attribute name="rev" description="Module revision"/>
        <attribute name="conf" default="default" description="Name of the ivy configuration to resolve"/>
        <attribute name="type" default="jar" description="Type of artifact to resolve"/>
        <attribute name="settingsRef" default="build-macros-ivy-settings" description="Reference to ivy settings"/>
        <attribute name="transitive" default="true" description="Whether to resolve dependencies transitively"/>
        <attribute name="log" default="download-only" description="When to log activity"/>
        <sequential>
            <ivy:resolve settingsRef="@{settingsRef}" organisation="@{org}" module="@{mod}" revision="@{rev}"
              type="@{type}" inline="true" transitive="@{transitive}" conf="@{conf}" log="@{log}"/>
            <ivy:retrieve settingsRef="@{settingsRef}" organisation="@{org}" module="@{mod}" revision="@{rev}"
              type="@{type}" inline="true" transitive="@{transitive}" conf="@{conf}" log="@{log}" pattern="@{pattern}"/>
        </sequential>
    </macrodef>

    <!--
        Macro for generating a resolution report for a given configuration.
        Requires a previous <ivy:resolve> operation.
    -->
    <macrodef uri="urn:org.dellroad.ant" name="ivyreport">
        <attribute name="conf" default="default" description="Name of the ivy configuration to report"/>
        <attribute name="destdir" default="build/reports/ivy" description="Directory in which to put generated reports"/>
        <attribute name="settingsRef" default="build-macros-ivy-settings" description="Reference to ivy settings"/>
        <sequential>
            <mkdir dir="@{destdir}"/>
            <ivy:report settingsRef="@{settingsRef}" conf="@{conf}" todir="@{destdir}" xml="true" outputpattern="[conf].[ext]"/>
        </sequential>
    </macrodef>

    <!-- Configure Ivy -->
    <antcontrib:if>
        <available file="${basedir}/src/ivy/settings.xml" type="file"/>
        <antcontrib:then>
            <ivy:settings id="build-macros-ivy-settings" file="${basedir}/src/ivy/settings.xml"/>
        </antcontrib:then>
        <antcontrib:else>
            <ivy:settings id="build-macros-ivy-settings" file="${build.macros.dir}/ivysettings.xml"/>
        </antcontrib:else>
    </antcontrib:if>

<!--
        ************* MACROS AND PRESETDEFS ****************
-->

    <!-- SVN revision -->
    <macrodef uri="urn:org.dellroad.ant" name="svnrevision">
        <attribute name="property" default="svn.revision" description="Name of property to set"/>
        <attribute name="dir" default="${basedir}" description="Target checked-out SVN directory"/>
        <sequential>
            <exec outputproperty="@{property}" executable="/bin/sh" logError="true" failonerror="true">
                <arg value="-c"/>
                <arg value="svnversion -c @{dir} | sed -e 's/^[0-9]\{1,\}://g' -e 's/^-1M$/0/g'"/>
            </exec>
        </sequential>
    </macrodef>

    <!-- SuSE version -->
    <macrodef uri="urn:org.dellroad.ant" name="suseversion">
        <attribute name="property" description="Name of property to set"/>
        <sequential>
            <exec outputproperty="@{property}" executable="/bin/bash" logError="true" failonerror="true">
                <arg value="-c"/>
                <arg value="SREL=`head -1 /etc/SuSE-release`;
                case &quot;$${SREL}&quot; in
                    SUSE\ LINUX\ Enterprise\ Server\ 9\ \(*)
                        echo -n sles9;
                        ;;
                    SUSE\ LINUX\ 10\.0\ \(*)
                        echo -n suse10.0;
                        ;;
                    SUSE\ LINUX\ 10\.1\ \(*)
                        echo -n suse10.1;
                        ;;
                    openSUSE\ [0-9][0-9]\.[0-9]\ \(*)
                        LABEL=`echo &quot;$${SREL}&quot; | sed 's|^openSUSE \([0-9]\{1,\}\.[0-9]\{1,\}\) (.*$$|\1|g'`;
                        echo -n &quot;$${LABEL}&quot;;
                        ;;
                    *)
                        echo -n unknown;
                        ;;
                esac"/>
            </exec>
        </sequential>
    </macrodef>

    <!--
        Schema Update Verification

        Requirements:

            - You must have a local MySQL instance running
            - You must have run the "setupSchemacheck.sql" script on it

        How this works:

          - The local MySQL database as a user "schemacheck" (same p/w) with all priviledges on schemacheck\_%
          - LiquiBase *should* automatically detect any schema differences and if so the build will fail
          - In any case, the SQL exports are diff'd as well; some differences might not be material but do a double check
    -->
    <macrodef uri="urn:org.dellroad.ant" name="schemacheck">
        <attribute name="original" description="Starting schema file"/>
        <attribute name="changes" description="Update schema file"/>
        <attribute name="expected" description="Expected result schema file"/>
        <attribute name="classpathref" description="Classpath reference containing MySQL driver and Liquibase &gt; 2.0.0"/>
        <sequential>

            <!-- Reset -->
            <delete dir="build/schemacheck"/>
            <mkdir dir="build/schemacheck"/>

            <!-- Create check databases -->
            <sql driver="com.mysql.jdbc.Driver" url="jdbc:mysql://localhost/" classpathref="@{classpathref}"
              userid="schemacheck" password="schemacheck" print="false" showheaders="false" showtrailers="false">
                <transaction>
                    DROP DATABASE IF EXISTS `schemacheck_1`;
                    DROP DATABASE IF EXISTS `schemacheck_2`;
                    CREATE DATABASE `schemacheck_1` DEFAULT CHARACTER SET utf8 COLLATE utf8_bin;
                    CREATE DATABASE `schemacheck_2` DEFAULT CHARACTER SET utf8 COLLATE utf8_bin;
                </transaction>
            </sql>

            <!-- Apply original schema plus all updates to database #1 -->
            <sql driver="com.mysql.jdbc.Driver" url="jdbc:mysql://localhost/schemacheck_1?autoGenerateTestcaseScript=true"
              classpathref="@{classpathref}" userid="schemacheck" password="schemacheck" print="false" showheaders="false"
              showtrailers="false" autocommit="true">
                <transaction src="@{original}"/>
                <transaction src="@{changes}"/>
            </sql>

            <!-- Apply up-to-date schema to database #2 -->
            <sql driver="com.mysql.jdbc.Driver" url="jdbc:mysql://localhost/schemacheck_2" classpathref="@{classpathref}"
              userid="schemacheck" password="schemacheck" print="false" showheaders="false" showtrailers="false">
                <transaction src="@{expected}"/>
            </sql>

            <!-- Dump schemas as flat files -->
            <exec executable="mysqldump" output="build/schemacheck/1.sql" logError="true" failonerror="true">
                <arg line="-u schemacheck --password=schemacheck --host=localhost --no-data schemacheck_1"/>
            </exec>
            <exec executable="mysqldump" output="build/schemacheck/2.sql" logError="true" failonerror="true">
                <arg line="-u schemacheck --password=schemacheck --host=localhost --no-data schemacheck_2"/>
            </exec>

            <!-- Compute schema diff using liquibase -->
            <taskdef resource="liquibasetasks.properties" classpathref="@{classpathref}"/>
            <diffDatabase driver="com.mysql.jdbc.Driver" classpathref="@{classpathref}"
              url="jdbc:mysql://localhost/schemacheck_1" username="schemacheck" password="schemacheck"
              referenceUrl="jdbc:mysql://localhost/schemacheck_2" referenceUsername="schemacheck" referencePassword="schemacheck"
              outputFile="build/schemacheck/diff.txt">
            </diffDatabase>
            <exec executable="sh" logError="true" failonerror="false">
                <arg value="-c"/>
                <arg value="
                    cat build/schemacheck/diff.txt
                       | grep -vE '^(Reference|Target) Database: '
                       | grep -vE ': (EQUAL|NONE)$$'
                       &gt; build/schemacheck/mismatch.txt;
                    true;
                "/>
            </exec>

            <!-- Drop databases -->
            <sql driver="com.mysql.jdbc.Driver" url="jdbc:mysql://localhost/" classpathref="@{classpathref}"
              userid="schemacheck" password="schemacheck" print="false" showheaders="false" showtrailers="false">
                DROP DATABASE `schemacheck_1`;
                DROP DATABASE `schemacheck_2`;
            </sql>

            <!-- Show liquibase schema differences -->
            <concat>
                <fileset file="build/schemacheck/mismatch.txt"/>
            </concat>
            <condition property="schemacheck.match">
                <filesmatch file1="build/schemacheck/mismatch.txt" file2="/dev/null"/>
            </condition>
            <fail message="ERROR: schema mismatch (see above for details)" unless="schemacheck.match"/>

            <!-- Show diff(1) of schema dumps -->
            <exec executable="diff" logError="true" failonerror="false">
                <arg value="-u"/>
                <arg value="-I"/>
                <arg value="^-- Host: localhost"/>
                <arg value="-I"/>
                <arg value="^-- Dump completed on"/>
                <arg value="build/schemacheck/1.sql"/>
                <arg value="build/schemacheck/2.sql"/>
            </exec>
        </sequential>
    </macrodef>

    <!-- RPM build -->
    <macrodef uri="urn:org.dellroad.ant" name="rpmbuild">
        <attribute name="specfile" default="${ant.project.name}.spec" description="Name of RPM spec file"/>
        <attribute name="buildflag" default="-bb" description="rpmbuild(1) build flag"/>
        <attribute name="rpmflags" default="" description="Additional flags to rpmbuild"/>
        <attribute name="fresh" default="true" description="Blow away old RPMs in dist/RPMS first"/>
        <element name="source-preparation" optional="yes"/>
        <sequential>
            <delete dir="build/rpm"/>
            <mkdir dir="build/rpm/BUILD"/>
            <mkdir dir="build/rpm/RPMS"/>
            <mkdir dir="build/rpm/SOURCES"/>
            <mkdir dir="build/rpm/SPECS"/>
            <mkdir dir="build/rpm/SRPMS"/>
            <antcontrib:if>
                <istrue value="@{fresh}"/>
                <antcontrib:then>
                    <delete dir="dist/RPMS"/>
                </antcontrib:then>
            </antcontrib:if>
            <mkdir dir="dist/RPMS"/>
            <dellroad:svnrevision property="svn_revision"/>
            <antcontrib:if>
                <available file="src/rpm/@{specfile}" type="file"/>
                <antcontrib:then>
                    <copy file="src/rpm/@{specfile}" todir="build/rpm/SPECS" verbose="true"/>
                </antcontrib:then>
            </antcontrib:if>
            <antcontrib:if>
                <available file="src/sources" type="dir"/>
                <antcontrib:then>
                    <copy todir="build/rpm/SOURCES" verbose="true">
                        <fileset dir="src/sources">
                            <include name="**/*"/>
                            <exclude name="**/.svn"/>
                        </fileset>
                    </copy>
                </antcontrib:then>
            </antcontrib:if>
            <source-preparation/>
            <!-- _topdir definition is a workaround for a bug in ant 1.7.0 Rpm.java, line 123 (missing space) -->
            <rpm topdir="build/rpm" specfile="@{specfile}" command="@{buildflag} --define '_topdir ${basedir}/build/rpm'
              --define 'svn_revision ${svn_revision}' @{rpmflags}" rpmBuildCommand="rpmbuild"
              failOnError="true"/>
            <copy todir="dist" overwrite="true" verbose="true">
                <fileset dir="build/rpm">
                    <include name="RPMS/*/*.rpm"/>
                </fileset>
            </copy>
        </sequential>
    </macrodef>

    <!--
        Unit test macro

        Requires:
            path "javac.classpath"
            path "unittest.classpath"
            path "testng.classpath"
            path "cobertura.classpath"
    -->
    <macrodef uri="urn:org.dellroad.ant" name="unit-tests">
        <attribute name="testngfile" default="${basedir}/src/test/testng.xml" description="TestNG control file"/>
        <element name="excludes" optional="yes"/>
        <element name="addclasspath" optional="yes"/>
        <element name="testng" optional="yes"/>
        <sequential>

            <!-- Define TestNG and Cobertura ant tasks -->
            <taskdef uri="urn:org.testng"
              resource="testngtasks" classpathref="testng.classpath"/>
            <taskdef uri="urn:net.sf.cobertura"
              resource="tasks.properties" classpathref="cobertura.classpath"/>

            <!-- Instrument Classes -->
            <delete dir="${basedir}/build/cobertura"/>
            <delete dir="${basedir}/build/reports/coverage"/>
            <mkdir dir="${basedir}/build/cobertura/classes"/>
            <mkdir dir="${basedir}/build/reports/coverage"/>
            <cobertura:cobertura-instrument todir="${basedir}/build/cobertura/classes"
              datafile="${basedir}/build/cobertura/cobertura.ser">
                <fileset dir="${basedir}/build/classes">
                    <include name="**/*.class"/>
                    <excludes/>
                </fileset>
            </cobertura:cobertura-instrument>

            <!-- Run tests -->
            <testng:testng outputDir="${basedir}/build/reports/tests" haltOnfailure="true">
                <xmlfileset file="@{testngfile}"/>
                <jvmarg value="-Djava.awt.headless=true"/>
                <sysproperty key="net.sourceforge.cobertura.datafile" file="${basedir}/build/cobertura/cobertura.ser"/>
                <classpath>
                    <addclasspath/>
                    <pathelement location="${basedir}/build/cobertura/classes"/>
                    <pathelement location="${basedir}/build/classes"/>
                    <pathelement location="${basedir}/build/test"/>
                    <pathelement location="${basedir}/build/resources"/>
                    <path refid="javac.classpath"/>
                    <path refid="unittest.classpath"/>
                    <path refid="cobertura.classpath"/>
                </classpath>
                <testng/>
            </testng:testng>

            <!-- Generate coverage report -->
            <cobertura:cobertura-report format="html" destdir="${basedir}/build/reports/coverage"
              srcdir="${basedir}/src/java" datafile="${basedir}/build/cobertura/cobertura.ser"/>
        </sequential>
    </macrodef>

    <presetdef uri="urn:org.dellroad.ant" name="javac-default">
        <javac includeantruntime="no"
               compiler="modern"
               deprecation="true"
               source="1.6"
               target="1.6"
               debug="true">
            <compilerarg line="${javac.compiler.flags}"/>
        </javac>
    </presetdef>

    <!--
        Javadoc macro

        Requires:
            path "javac.classpath"
        Optional:
            property "javac.compiler.flags"
    -->
    <macrodef uri="urn:org.dellroad.ant" name="javadoc">
        <attribute name="title" default="Java Class Library API"/>
        <attribute name="overview" default="${basedir}/src/java/overview.html"/>
        <element name="links" optional="yes"/>
        <element name="excludes" optional="yes"/>
        <element name="additional-classpath" optional="yes"/>
        <sequential>
            <antcontrib:outofdate>
                <sourcefiles>
                    <fileset dir="src/java">
                        <include name="**/*.java"/>
                        <excludes/>
                    </fileset>
                </sourcefiles>
                <targetfiles path="build/reports/javadoc/index.html"/>
                <sequential>
                    <delete dir="build/reports/javadoc"/>
                    <mkdir dir="build/reports/javadoc"/>
                    <javadoc destdir="build/reports/javadoc" use="true" overview="@{overview}"
                      source="1.5" breakiterator="yes" linksource="true"
                      windowtitle="@{title}" doctitle="@{title}" failonerror="true">
                        <classpath>
                            <path refid="javac.classpath"/>
                            <additional-classpath/>
                        </classpath>
                        <packageset dir="src/java" defaultexcludes="yes">
                            <include name="**/*"/>
                            <excludes/>
                        </packageset>
                        <links/>
                    </javadoc>
                </sequential>
            </antcontrib:outofdate>
        </sequential>
    </macrodef>

    <!--
        Checkstyle macro

        Requires:
            path "javac.classpath"
            path "unittest.classpath"
            path "checkstyle.classpath"
    -->
    <macrodef uri="urn:org.dellroad.ant" name="checkstyle">
        <attribute name="config" default="${build.macros.dir}/checkstyle/checkstyle.xml"/>
        <attribute name="style" default="${build.macros.dir}/checkstyle/checkstyle-frames-errors.xsl"/>
        <attribute name="textstyle" default="${build.macros.dir}/checkstyle/checkstyle-text.xsl"/>
        <attribute name="dir" default="${basedir}/build/reports/checkstyle"/>
        <attribute name="title" default="DellRoad.ORG Checkstyle Report"/>
        <attribute name="maxErrors" default="0"/>
        <attribute name="maxWarnings" default="0"/>
        <attribute name="showWarnings" default="true"/>
        <element name="excludes" optional="yes"/>
        <sequential>
            <mkdir dir="@{dir}"/>

            <!-- (Re)run checkstyle if necessary -->
            <antcontrib:outofdate>
                <sourcefiles>
                    <fileset dir="src">
                        <include name="**/*.java"/>
                        <exclude name="**/*MBean.java"/>
                        <excludes/>
                    </fileset>
                </sourcefiles>
                <targetfiles path="${dir}/report.xml"/>
                <sequential>

                    <!-- Run checkstyle -->
                    <delete dir="@{dir}"/>
                    <mkdir dir="@{dir}"/>
                    <taskdef uri="urn:net.sf.checkstyle"
                      resource="checkstyletask.properties" classpathref="checkstyle.classpath"/>
                    <checkstyle:checkstyle failOnViolation="false" failureProperty="checkstyle.failed"
                      config="@{config}" maxErrors="@{maxErrors}" maxWarnings="@{maxWarnings}">
                        <property key="checkstyle.cache.file" file="@{dir}/cachefile"/>
                        <formatter type="xml" toFile="@{dir}/report.xml"/>
                        <fileset dir="${basedir}/src">
                            <include name="**/*.java"/>
                            <exclude name="**/*MBean.java"/>
                            <excludes/>
                        </fileset>
                        <classpath>
                            <pathelement location="${basedir}/build/classes"/>
                            <pathelement location="${basedir}/build/test"/>
                            <path refid="javac.classpath"/>
                            <path refid="unittest.classpath"/>
                        </classpath>
                    </checkstyle:checkstyle>

                    <!-- Style XML report -->
                <!--
                    <xslt in="@{dir}/report.xml" out="@{dir}/report.out" style="@{style}">
                        <param name="title" expression="@{title}"/>
                        <param name="filename.strip.prefix" expression="${basedir}/"/>
                    </xslt>
                -->

                    <!-- Output textual version of report -->
                    <antcontrib:if>
                        <isset property="checkstyle.failed"/>
                        <antcontrib:then>
                            <xslt style="@{textstyle}" in="@{dir}/report.xml" out="/dev/stdout">
                                <param name="failed" expression="true"/>
                                <param name="filename.strip.prefix" expression="${basedir}/"/>
                                <param name="show.warnings" expression="@{showWarnings}"/>
                            </xslt>
                            <fail message="checkstyle failed"/>
                        </antcontrib:then>
                        <antcontrib:else>
                            <xslt style="@{textstyle}" in="@{dir}/report.xml" out="/dev/stdout">
                                <param name="failed" expression="false"/>
                                <param name="filename.strip.prefix" expression="${basedir}/"/>
                                <param name="show.warnings" expression="@{showWarnings}"/>
                            </xslt>
                        </antcontrib:else>
                    </antcontrib:if>
                </sequential>
            </antcontrib:outofdate>
        </sequential>
    </macrodef>

    <!--
        FindBugs macro

        Requires:
            path "findbugs.classpath"
    -->
    <macrodef uri="urn:org.dellroad.ant" name="findbugs">
        <attribute name="dir" description="Output directory" default="${basedir}/build/reports/findbugs"/>
        <attribute name="location" description="Directory where FindBugs is installed"/>
        <attribute name="reportLevel" description="Reporting level: low, medium, high" default="low"/>
        <attribute name="style" description="Report style: plain, default, fancy, fancy-hist, summary" default="default"/>
        <attribute name="effortLevel" description="Effort level: min, default, max" default="default"/>
        <sequential>

            <!-- Verify FindBugs exists -->
            <available file="@{location}" type="dir" property="findbugs.home.exists"/>
            <fail unless="findbugs.home.exists" message="Directory @{location} does not exist"/>

            <!-- Run FindBugs -->
            <antcontrib:outofdate>
                <sourcefiles>
                    <fileset dir="src/java" includes="**/*.java"/>
                </sourcefiles>
                <targetfiles path="@{dir}/report.xml"/>
                <sequential>

                    <!-- Clear out old stuff -->
                    <delete dir="@{dir}"/>
                    <mkdir dir="@{dir}"/>

                    <!-- Define task -->
                    <taskdef uri="urn:edu.umd.cs.findbugs" name="findbugs"
                      classpath="@{location}/lib/findbugs.jar"
                      classname="edu.umd.cs.findbugs.anttask.FindBugsTask"/>

                    <!-- Generate XML report -->
                    <findbugs:findbugs home="@{location}" outputFile="@{dir}/report.xml"
                      output="xml:withMessages" reportLevel="@{reportLevel}" effort="@{effortLevel}">
                        <auxClasspath refid="findbugs.classpath"/>
                        <sourcePath path="${basedir}/src/java" />
                        <class location="${basedir}/build/classes" />
                    </findbugs:findbugs>
                </sequential>
            </antcontrib:outofdate>

            <!-- Style that into HTML report -->
            <antcontrib:outofdate>
                <sourcefiles>
                    <fileset dir="@{dir}" includes="report.xml"/>
                </sourcefiles>
                <targetfiles path="@{dir}/index.html"/>
                <sequential>
                    <xslt style="@{location}/src/xsl/@{style}.xsl" in="@{dir}/report.xml" out="@{dir}/index.html"/>
                </sequential>
            </antcontrib:outofdate>
        </sequential>
    </macrodef>

    <!--
        Show FindBugs macro
    -->
    <macrodef uri="urn:org.dellroad.ant" name="showbugs">
        <attribute name="dir" description="Output directory" default="${basedir}/build/reports/findbugs"/>
        <attribute name="location" description="Directory where FindBugs is installed"/>
        <sequential>
            <available file="@{dir}/report.xml" type="file" property="findbugs.report.exists"/>
            <fail unless="findbugs.report.exists" message="File @{dir}/report.xml does not exist"/>
            <exec executable="@{location}/bin/findbugs" logError="true" failonerror="true">
                <arg value="-loadbugs"/>
                <arg value="@{dir}/report.xml"/>
                <arg value="-home"/>
                <arg value="@{location}"/>
            </exec>
        </sequential>
    </macrodef>

<!--
        ************* PREDEFINED TARGETS ****************
-->

    <target name="clean" depends="clean-project">
        <delete dir="build"/>
        <delete dir="dist"/>
    </target>
    <target name="clean-project"/>

    <!-- Find TestNG -->
    <target name="testng.classpath" unless="testng.classpath.resolved">
        <dellroad:ivymodpath pathid="testng.classpath" rev="5.14.5" org="org.testng" mod="testng"/>
        <property name="testng.classpath.resolved" value="true"/>
    </target>

    <!-- Find Cobertura -->
    <target name="cobertura.classpath" unless="cobertura.classpath.resolved">
        <dellroad:ivymodpath pathid="cobertura.classpath" rev="[1.9.4,2.0[" org="net.sourceforge.cobertura" mod="cobertura"/>
        <property name="cobertura.classpath.resolved" value="true"/>
    </target>

    <!-- Find Checkstyle -->
    <target name="checkstyle.classpath" unless="checkstyle.classpath.resolved">
        <dellroad:ivymodpath pathid="checkstyle.classpath" rev="5.3" org="com.puppycrawl" mod="checkstyle"/>
        <property name="checkstyle.classpath.resolved" value="true"/>
    </target>

    <target name="javac" depends="javac-project, javac.classpath, testng.classpath" unless="javac.completed">

        <!-- Main classes -->
        <antcontrib:if>
            <available file="src/java" type="dir"/>
            <antcontrib:then>
                <mkdir dir="build/classes"/>
                <antcontrib:outofdate>
                    <sourcefiles>
                        <fileset dir="src/java">
                            <include name="**/*.java"/>
                            <exclude name="**/package-info.java"/>
                        </fileset>
                    </sourcefiles>
                    <mapper type="glob" dir="src/java" from="*.java" to="build/classes/*.class"/>
                    <sequential>
                        <mkdir dir="build/classes"/>
                        <dellroad:javac-default srcdir="src/java" destdir="build/classes">
                            <classpath refid="javac.classpath"/>
                            <compilerarg line="-proc:none"/>
                        </dellroad:javac-default>
                    </sequential>
                </antcontrib:outofdate>
            </antcontrib:then>
        </antcontrib:if>

        <!-- Test classes -->
        <antcontrib:if>
            <available file="src/test" type="dir"/>
            <antcontrib:then>
                <antcontrib:outofdate>
                    <sourcefiles>
                        <fileset dir="src/test">
                            <include name="**/*.java"/>
                            <exclude name="**/package-info.java"/>
                        </fileset>
                    </sourcefiles>
                    <mapper type="glob" dir="src/test" from="*.java" to="build/test/*.class"/>
                    <sequential>
                        <mkdir dir="build/test"/>
                        <dellroad:javac-default srcdir="src/test" destdir="build/test">
                            <classpath path="build/classes"/>
                            <classpath refid="javac.classpath"/>
                            <classpath refid="testng.classpath"/>
                        </dellroad:javac-default>
                    </sequential>
                </antcontrib:outofdate>
            </antcontrib:then>
        </antcontrib:if>
        <property name="javac.completed" value="true"/>
    </target>
    <target name="javac-project"/>

    <target name="reports" depends="reports-project">
        <dellroad:svnrevision property="svn_revision"/>
        <tstamp>
            <format property="current.time" pattern="EEEE dd MMM yyyy HH:mm:ss"/>
        </tstamp>
        <xslt style="${build.macros.dir}/reports-index.xsl"
          in="${build.macros.dir}/reports-index.xsl" out="build/reports/index.html">
            <param name="basedir" expression="${basedir}"/>
            <param name="ant.project.name" expression="${ant.project.name}"/>
            <param name="svn.revision" expression="${svn_revision}"/>
            <param name="version" expression="${version}"/>
            <param name="timestamp" expression="${current.time}"/>
        </xslt>
        <antcontrib:if>
            <available file="src/java" type="dir"/>
            <antcontrib:then>
                <antcall target="javadoc" inheritRefs="true"/>
            </antcontrib:then>
        </antcontrib:if>
        <antcontrib:if>
            <available file="src/java" type="dir"/>
            <antcontrib:then>
                <antcall target="checkstyle" inheritRefs="true"/>
            </antcontrib:then>
        </antcontrib:if>
        <antcontrib:if>
            <available file="src/test" type="dir"/>
            <antcontrib:then>
                <antcall target="tests" inheritRefs="true"/>
            </antcontrib:then>
        </antcontrib:if>
<!--
        <antcontrib:if>
            <available file="src/java" type="dir"/>
            <antcontrib:then>
                <antcall target="findbugs" inheritRefs="true"/>
            </antcontrib:then>
        </antcontrib:if>
-->
    </target>
    <target name="reports-project"/>

    <target name="remove-unused-imports">
        <exec executable="/bin/bash" logError="true" failonerror="true">
            <arg value="-c"/>
            <arg value="
                if ! [ -f build/reports/checkstyle/report.xml ]; then
                    echo 'ERROR: you must run &#34;ant checks-checkstyle&#34; first!';
                    exit 1;
                fi;
                if [ -f build/reports/checkstyle/removeUnusedImports.sh ]; then
                    echo 'ERROR: only run &#34;ant remove-unused-imports&#34; once!';
                    exit 1;
                fi;
            "/>
        </exec>
        <xslt style="${build.macros.dir}/checkstyle/unused-imports.xsl"
          in="build/reports/checkstyle/report.xml" out="build/reports/checkstyle/removeUnusedImports.sh"/>
        <exec executable="/bin/bash" logError="true" failonerror="true">
            <arg value="-x"/>
            <arg value="build/reports/checkstyle/removeUnusedImports.sh"/>
        </exec>
    </target>

    <!-- Application should override -->
    <target name="javac.classpath"/>

</project>

